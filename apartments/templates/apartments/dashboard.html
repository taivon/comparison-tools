{% extends 'apartments/base.html' %}
{% load distance_filters %}

{% block title %}Dashboard - Your Apartments{% endblock %}

{% block extra_head %}
<style>
/* Sticky column styles for apartment comparison table */
.sticky-col-left {
    position: sticky;
    left: 0;
    z-index: 11;
}
.sticky-col-right {
    position: sticky;
    right: 0;
    z-index: 10;
}
/* Background colors for sticky columns - Light mode */
thead .sticky-col-left,
thead .sticky-col-right {
    background-color: rgb(249 250 251); /* bg-gray-50 */
}
tbody .sticky-col-left,
tbody .sticky-col-right {
    background-color: white;
}
tbody tr:hover .sticky-col-left,
tbody tr:hover .sticky-col-right {
    background-color: rgb(249 250 251); /* hover:bg-gray-50 */
}
/* Shadow indicator when scrolling */
.sticky-col-left {
    box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.1);
}
.sticky-col-right {
    box-shadow: -2px 0 5px -2px rgba(0, 0, 0, 0.1);
}
/* Dark mode support (class-based for Tailwind) */
.dark thead .sticky-col-left,
.dark thead .sticky-col-right {
    background-color: rgb(38 38 38); /* neutral-800 */
}
.dark tbody .sticky-col-left,
.dark tbody .sticky-col-right {
    background-color: rgb(38 38 38); /* neutral-800 */
}
.dark tbody tr:hover .sticky-col-left,
.dark tbody tr:hover .sticky-col-right {
    background-color: rgb(64 64 64); /* neutral-700 */
}
.dark .sticky-col-left {
    box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.4);
}
.dark .sticky-col-right {
    box-shadow: -2px 0 5px -2px rgba(0, 0, 0, 0.4);
}
/* Tooltip styles - Light mode (dark tooltip) */
.net-effective-tooltip {
    background-color: rgb(17 24 39); /* gray-900 */
    color: white;
}
.net-effective-tooltip .tooltip-arrow {
    background-color: rgb(17 24 39); /* gray-900 */
}
/* Tooltip styles - Dark mode (light tooltip) */
.dark .net-effective-tooltip {
    background-color: white;
    color: rgb(17 24 39);
    border: 1px solid rgb(229 231 235); /* gray-200 */
}
.dark .net-effective-tooltip .tooltip-arrow {
    background-color: white;
    border: 1px solid rgb(229 231 235);
}
.dark .net-effective-tooltip .font-semibold.mb-2 {
    color: rgb(55 65 81); /* gray-700 */
}
.dark .net-effective-tooltip .text-gray-400 {
    color: rgb(107 114 128); /* gray-500 */
}
.dark .net-effective-tooltip .text-gray-300 {
    color: rgb(55 65 81); /* gray-700 */
}
.dark .net-effective-tooltip .text-green-400 {
    color: rgb(22 163 74); /* green-600 */
}
.dark .net-effective-tooltip .border-gray-700 {
    border-color: rgb(229 231 235); /* gray-200 */
}
.dark .net-effective-tooltip .text-gray-500 {
    color: rgb(156 163 175); /* gray-400 */
}
/* Score breakdown tooltip styles - Light mode (dark tooltip) */
.score-breakdown-tooltip {
    background-color: rgb(17 24 39); /* gray-900 */
    color: white;
}
.score-breakdown-tooltip .tooltip-arrow {
    background-color: rgb(17 24 39); /* gray-900 */
}
/* Score breakdown tooltip - Dark mode (light tooltip) */
.dark .score-breakdown-tooltip {
    background-color: white;
    color: rgb(17 24 39);
    border: 1px solid rgb(229 231 235); /* gray-200 */
}
.dark .score-breakdown-tooltip .tooltip-arrow {
    background-color: white;
    border: 1px solid rgb(229 231 235);
}
.dark .score-breakdown-tooltip .font-semibold {
    color: rgb(55 65 81); /* gray-700 */
}
.dark .score-breakdown-tooltip .text-gray-300 {
    color: rgb(75 85 99); /* gray-600 */
}
.dark .score-breakdown-tooltip .text-gray-500 {
    color: rgb(107 114 128); /* gray-500 */
}
.dark .score-breakdown-tooltip .border-gray-700 {
    border-color: rgb(229 231 235); /* gray-200 */
}
/* Table text colors for dark mode */
.dark tbody .text-gray-900 {
    color: white;
}
.dark tbody .text-gray-500 {
    color: rgb(156 163 175); /* gray-400 */
}
.dark thead {
    background-color: rgb(38 38 38); /* neutral-800 */
}
.dark thead .text-gray-500 {
    color: rgb(156 163 175); /* gray-400 */
}

/* Score column - not sticky, just prominent */

/* Score tooltip styles */
.score-tooltip {
    position: absolute;
    background-color: rgb(17 24 39);
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.875rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    z-index: 50;
    min-width: 200px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
}

.score-tooltip.show {
    opacity: 1;
}

.dark .score-tooltip {
    background-color: white;
    color: rgb(17 24 39);
    border: 1px solid rgb(229 231 235);
}

/* Simple range slider */
input[type="range"].score-slider {
    width: 100%;
    cursor: pointer;
}
</style>
<script>
// Calculate individual discount amount - defined early so it can be used inline
function calculateDiscountAmount(price, amount, type, discountCalcMethod) {
    const annualRent = price * 12;
    let discountValue = 0;

    if (discountCalcMethod === 'daily') {
        const dailyRate = annualRent / 365;
        if (type === 'months') {
            const daysFromMonths = amount * (365 / 12);
            discountValue = dailyRate * daysFromMonths;
        } else if (type === 'weeks') {
            discountValue = dailyRate * amount * 7;
        }
    } else if (discountCalcMethod === 'weekly') {
        const weeklyRate = annualRent / 52;
        if (type === 'months') {
            const weeksFromMonths = amount * (52 / 12);
            discountValue = weeklyRate * weeksFromMonths;
        } else if (type === 'weeks') {
            discountValue = weeklyRate * amount;
        }
    } else {
        // Monthly fallback
        if (type === 'months') {
            discountValue = price * amount;
        } else if (type === 'weeks') {
            discountValue = price * (amount / 4);
        }
    }

    return discountValue;
}
</script>
{% endblock %}

{% block breadcrumbs %}
<nav class="bg-gray-50 dark:bg-neutral-900 border-b border-gray-200 dark:border-neutral-800" aria-label="Breadcrumb">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <ol class="flex items-center space-x-2 py-3 text-sm">
            <li>
                <a href="{% url 'home' %}" class="text-gray-500 dark:text-gray-400 hover:text-brand-purple dark:hover:text-brand-purple-light">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                    </svg>
                    <span class="sr-only">Home</span>
                </a>
            </li>
            <li class="flex items-center">
                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                <a href="{% url 'apartments:index' %}" class="ml-2 text-gray-500 dark:text-gray-400 hover:text-brand-purple dark:hover:text-brand-purple-light">Apartments</a>
            </li>
            <li class="flex items-center">
                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="ml-2 text-gray-900 dark:text-white font-medium" aria-current="page">Dashboard</span>
            </li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<!-- Dashboard Section -->
<div class="bg-white dark:bg-neutral-800 border-b border-gray-200 dark:border-neutral-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="py-4 sm:py-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Your Apartments</h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        <span id="apartmentCountText">{{ apartment_count }} apartment{{ apartment_count|pluralize }} compared</span>
                        {% if not is_premium %}
                            <span id="apartmentCountBadge" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if apartment_count >= apartment_limit %}bg-red-100 text-red-800{% elif apartment_count >= 1 %}bg-amber-100 text-amber-800{% else %}bg-green-100 text-green-800{% endif %}">
                                <span id="apartmentCountBadgeText">
                                {% if apartment_count >= apartment_limit %}
                                    Limit reached
                                {% elif apartment_count >= 1 %}
                                    {{ apartment_count }}/{{ apartment_limit }} used
                                {% else %}
                                    Free tier
                                {% endif %}
                                </span>
                            </span>
                        {% endif %}
                    </p>
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
                    <div class="flex items-center gap-3">
                        <!-- Favorite Places Link (Premium Only) -->
                        {% if user.is_authenticated %}
                            {% if is_premium %}
                            <a href="{% url 'apartments:favorite_places' %}" class="p-2.5 sm:p-2 text-gray-700 hover:text-brand-purple hover:bg-gray-50 rounded-lg border border-gray-300 transition-colors touch-manipulation relative" title="Favorite Places ({{ favorite_place_count }}/{{ favorite_place_limit }})">
                                <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                {% if favorite_place_count > 0 %}
                                <span class="absolute -top-1 -right-1 inline-flex items-center justify-center w-4 h-4 text-xs font-bold text-white bg-brand-purple rounded-full">{{ favorite_place_count }}</span>
                                {% endif %}
                            </a>
                            {% else %}
                            <a href="{% url 'signup' %}" class="inline-flex items-center px-3 py-2 text-xs font-medium text-white bg-brand-purple hover:bg-brand-purple-dark rounded-lg transition-colors" title="Upgrade to unlock distance calculations">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Locations
                                <span class="ml-1.5 px-1.5 py-0.5 bg-white/20 rounded text-xxs font-semibold">PRO</span>
                            </a>
                            {% endif %}

                            <!-- Preferences Button -->
                            <button onclick="openScoreTuner()" class="p-2.5 sm:p-2 text-gray-700 hover:text-brand-purple hover:bg-gray-50 rounded-lg border border-gray-300 transition-colors touch-manipulation" title="Customize scoring and calculations">
                                <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                        {% endif %}

                        <!-- Feedback Button -->
                        <a href="{% url 'feedback:feedback_create' %}" class="p-2.5 sm:p-2 text-gray-700 dark:text-gray-300 hover:text-brand-purple hover:bg-gray-50 dark:hover:bg-neutral-700 rounded-lg border border-gray-300 dark:border-neutral-600 transition-colors touch-manipulation" title="Send Feedback">
                            <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                            </svg>
                        </a>

                        <!-- Feature Ideas Button -->
                        <a href="{% url 'feedback:feature_list' %}" class="p-2.5 sm:p-2 text-gray-700 dark:text-gray-300 hover:text-brand-purple hover:bg-gray-50 dark:hover:bg-neutral-700 rounded-lg border border-gray-300 dark:border-neutral-600 transition-colors touch-manipulation" title="Feature Ideas & Roadmap">
                            <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </a>

                    </div>

                    {% if can_add_apartment %}
                        <button onclick="openAddApartmentModal()" class="inline-flex items-center justify-center px-4 py-3 sm:py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-brand-purple hover:bg-brand-purple-light transition-colors touch-manipulation min-h-[44px]">
                            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Apartment
                        </button>
                    {% else %}
                        <div class="inline-flex items-center justify-center px-4 py-3 sm:py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-500 bg-gray-100 cursor-not-allowed min-h-[44px]">
                            <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="hidden sm:inline">Limit Reached ({{ apartment_count }}/{{ apartment_limit }})</span>
                            <span class="sm:hidden">Limit Reached</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anonymous User Signup Prompt -->
{% if is_anonymous %}
    <div id="signupPrompt" class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 border-b border-gray-200 dark:border-neutral-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-start sm:items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-purple-900 dark:text-purple-100">
                            {% if apartment_count >= 2 %}
                                You've reached the guest limit! Sign up to save your comparisons and add unlimited apartments.
                            {% else %}
                                Trying out our apartment comparison? Sign up to save your data and compare unlimited apartments!
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="text-sm font-medium text-purple-700 dark:text-purple-300 hover:text-purple-900 dark:hover:text-purple-100 min-h-[44px] flex items-center px-3 touch-manipulation">
                        Sign In
                    </a>
                    <a href="{% url 'signup' %}" class="inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors min-h-[44px] touch-manipulation flex-1 sm:flex-initial">
                        Sign Up Free
                    </a>
                    <button onclick="dismissSignupPrompt()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 min-h-[44px] min-w-[44px] flex items-center justify-center touch-manipulation">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Premium Upgrade Banner for Free Users -->
{% if stripe_enabled and user.is_authenticated and not is_premium %}
    <div id="upgradePrompt" class="bg-gradient-to-r from-brand-purple/10 to-brand-purple-light/10 dark:from-brand-purple/20 dark:to-brand-purple-light/20 border-b border-brand-purple/20 dark:border-brand-purple/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-start sm:items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-brand-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">
                            {% if apartment_count >= apartment_limit %}
                                You've reached the free plan limit ({{ apartment_limit }} apartments). Upgrade to Pro for unlimited comparisons!
                            {% elif apartment_count >= 1 %}
                                You're using {{ apartment_count }}/{{ apartment_limit }} apartments on the free plan. Upgrade to Pro for unlimited comparisons starting at $9.99/month!
                            {% else %}
                                Upgrade to Pro for unlimited apartment comparisons starting at $9.99/month!
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <a href="{% url 'signup' %}" class="inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-md text-white bg-brand-purple hover:bg-brand-purple-dark transition-colors min-h-[44px] touch-manipulation flex-1 sm:flex-initial">
                        Upgrade to Pro
                    </a>
                    <button onclick="dismissUpgradePrompt()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 min-h-[44px] min-w-[44px] flex items-center justify-center touch-manipulation">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Favorite Places Prompt for Premium Users -->
{% if user.is_authenticated and is_premium and apartment_count > 0 and favorite_place_count == 0 %}
    <div id="favoritePlacesPrompt" class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-b border-green-200 dark:border-green-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="flex items-start sm:items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-900 dark:text-green-100">
                            Add your favorite places to see commute times for each apartment!
                        </p>
                        <p class="text-xs text-green-700 dark:text-green-300 mt-0.5">
                            Add locations like work, gym, or family to calculate driving distances.
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <a href="{% url 'apartments:create_favorite_place' %}" class="inline-flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors min-h-[44px] touch-manipulation flex-1 sm:flex-initial">
                        Add Place
                    </a>
                    <button onclick="dismissFavoritePlacesPrompt()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 min-h-[44px] min-w-[44px] flex items-center justify-center touch-manipulation">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Apartments Views Container -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Top 3 Ranking View -->
    {% if user.is_authenticated and apartments|length >= 3 %}
    <div class="mb-6 bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-yellow-900/10 dark:to-amber-900/10 rounded-xl border border-yellow-200 dark:border-yellow-800/30 p-6">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <svg class="w-6 h-6 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
            </svg>
            Top Ranked Apartments
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for apartment in apartments|slice:":3" %}
            {% if apartment.score %}
            <div class="bg-white dark:bg-neutral-800 rounded-lg p-4 border-2 {% if forloop.counter == 1 %}border-yellow-400{% elif forloop.counter == 2 %}border-gray-300{% else %}border-amber-600{% endif %}">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center">
                        <span class="text-3xl mr-2">{% if forloop.counter == 1 %}üèÜ{% elif forloop.counter == 2 %}ü•à{% else %}ü•â{% endif %}</span>
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">{% if forloop.counter == 1 %}Best Overall{% elif forloop.counter == 2 %}Runner Up{% else %}Third Place{% endif %}</div>
                            <div class="font-bold text-gray-900 dark:text-white">{{ apartment.name }}</div>
                        </div>
                    </div>
                    <div class="text-right relative group">
                        <div class="flex items-center justify-end cursor-help">
                            <div class="text-2xl font-bold {% if apartment.score >= 9 %}text-green-700{% elif apartment.score >= 7 %}text-green-600{% elif apartment.score >= 5 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                {{ apartment.score|floatformat:1 }}
                            </div>
                            <svg class="h-4 w-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-xs text-gray-500">/10</div>
                        <!-- Score Breakdown Tooltip -->
                        {% if apartment.score_breakdown %}
                        <div class="score-breakdown-tooltip hidden group-hover:block absolute right-0 top-full mt-2 z-50 w-64 text-xs rounded-lg shadow-lg p-3 text-left">
                            <div class="font-semibold mb-2 text-gray-300">Score Breakdown</div>
                            <div class="space-y-1.5">
                                {% for factor in apartment.score_breakdown.factors %}
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300">{{ factor.name }} <span class="text-gray-500">({{ factor.weight_pct }}%)</span></span>
                                    <span class="font-medium">+{{ factor.contribution }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="border-t border-gray-700 mt-2 pt-2 flex justify-between items-center font-semibold">
                                <span>Total</span>
                                <span>{{ apartment.score|floatformat:1 }}/10</span>
                            </div>
                            <div class="tooltip-arrow absolute right-4 -top-1.5 w-3 h-3 transform rotate-45"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-300 mt-2">
                    <div>${{ apartment.price|floatformat:0 }}/mo ‚Ä¢ {{ apartment.square_footage|floatformat:0 }} sq ft</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Mobile Sort Controls -->
    <div class="sm:hidden mb-4">
        <div class="flex gap-3">
            <div class="flex-1">
                <label for="mobileSortField" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sort by</label>
                <select id="mobileSortField" onchange="updateMobileSort()" class="block w-full px-3 py-2 bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-brand-purple text-sm">
                    {% if user.is_authenticated %}
                    <option value="score" selected>Score</option>
                    {% endif %}
                    <option value="name">Name</option>
                    <option value="price">Price</option>
                    {% if has_discounts %}
                    <option value="net_price">Net Effective</option>
                    {% endif %}
                    <option value="square_footage">Square Footage</option>
                    <option value="bedrooms">Bedrooms</option>
                    <option value="bathrooms">Bathrooms</option>
                    <option value="price_per_sqft">Price/sq ft</option>
                    {% if has_discounts %}
                    <option value="discount">Discount</option>
                    {% endif %}
                    {% if favorite_places %}
                    <option value="avg_distance">Avg Time</option>
                    {% endif %}
                </select>
            </div>
            <div class="w-28">
                <label for="mobileSortOrder" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Order</label>
                <select id="mobileSortOrder" onchange="updateMobileSort()" class="block w-full px-3 py-2 bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-brand-purple text-sm">
                    <option value="desc" selected>DESC</option>
                    <option value="asc">ASC</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Card View - Mobile only -->
    <div id="cardView" class="grid grid-cols-1 gap-6 sm:hidden">
        {% for apartment in apartments %}
            <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 hover:shadow-md transition-shadow duration-200"
                 data-name="{{ apartment.name|lower }}"
                 data-price="{{ apartment.price }}"
                 data-net-price="{{ apartment.net_effective_price|default:apartment.price }}"
                 data-sqft="{{ apartment.square_footage }}"
                 data-bedrooms="{{ apartment.bedrooms|default:1 }}"
                 data-bathrooms="{{ apartment.bathrooms|default:1 }}"
                 data-score="{{ apartment.score|default:0 }}"
                 data-price-per-sqft="{{ apartment.price_per_sqft }}"
                 data-discount-amount="0"
                 data-avg-distance="{{ apartment.average_travel_time|default:'999' }}"
                 id="mobile-card-{{ apartment.pk|default:forloop.counter }}">
                <!-- Card Header: Score + Name + Badges -->
                <div class="px-4 py-3 border-b border-gray-100 dark:border-neutral-700">
                    <div class="flex items-center gap-3">
                        {% if user.is_authenticated and apartment.score %}
                            <div class="group relative flex-shrink-0">
                                <div class="inline-flex items-center px-2.5 py-1.5 rounded-lg text-sm font-bold cursor-help
                                    {% if apartment.score >= 9 %}bg-green-100 text-green-800{% elif apartment.score >= 7 %}bg-green-50 text-green-700{% elif apartment.score >= 5 %}bg-yellow-50 text-yellow-700{% else %}bg-red-50 text-red-700{% endif %}">
                                    <svg class="w-3.5 h-3.5 mr-1 {% if apartment.score >= 9 %}text-green-600{% elif apartment.score >= 7 %}text-green-500{% elif apartment.score >= 5 %}text-yellow-500{% else %}text-red-500{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                    {{ apartment.score|floatformat:1 }}
                                </div>
                                {% if apartment.score_breakdown %}
                                <div class="score-breakdown-tooltip hidden group-hover:block absolute left-0 top-10 z-50 w-64 text-xs rounded-lg shadow-lg p-3">
                                    <div class="font-semibold mb-2 text-gray-300">Score Breakdown</div>
                                    <div class="space-y-1.5">
                                        {% for factor in apartment.score_breakdown.factors %}
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300">{{ factor.name }} <span class="text-gray-500">({{ factor.weight_pct }}%)</span></span>
                                            <span class="font-medium">+{{ factor.contribution }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="border-t border-gray-700 mt-2 pt-2 flex justify-between items-center font-semibold">
                                        <span>Total</span>
                                        <span>{{ apartment.score|floatformat:1 }}/10</span>
                                    </div>
                                    <div class="tooltip-arrow absolute left-4 -top-1.5 w-3 h-3 transform rotate-45"></div>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        <h3 class="text-base font-semibold text-gray-900 dark:text-white truncate flex-1">{{ apartment.name }}</h3>
                        <div class="flex items-center gap-1.5 flex-shrink-0">
                            {% if apartment.months_free or apartment.weeks_free or apartment.flat_discount %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-brand-green/10 text-brand-green">Deal</span>
                            {% endif %}
                            {% if apartment.address %}
                                {% if apartment.latitude and apartment.longitude %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400" title="{{ apartment.address }}">
                                        <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400" title="Could not find: {{ apartment.address }}">
                                        <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                    </span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <!-- Top-ranked badge -->
                    {% if forloop.counter == 1 %}
                        <div class="mt-1.5 text-xs font-medium text-amber-600">ü•á Best Overall</div>
                    {% elif forloop.counter == 2 %}
                        <div class="mt-1.5 text-xs font-medium text-gray-500">ü•à Runner Up</div>
                    {% elif forloop.counter == 3 %}
                        <div class="mt-1.5 text-xs font-medium text-amber-700">ü•â Third Place</div>
                    {% endif %}
                </div>

                <!-- Card Body -->
                <div class="px-4 py-3 space-y-3">
                    <!-- Price Row -->
                    <div class="flex items-baseline justify-between">
                        <div class="text-xl font-bold text-gray-900 dark:text-white">${{ apartment.price|floatformat:0 }}<span class="text-sm font-normal text-gray-500">/mo</span></div>
                        {% if apartment.net_effective_price != apartment.price %}
                            <div class="group relative">
                                <div class="text-sm font-semibold text-brand-green cursor-help flex items-center">
                                    ${{ apartment.net_effective_price|floatformat:0 }} effective
                                    <svg class="w-3 h-3 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="net-effective-tooltip hidden group-hover:block absolute z-50 w-64 bg-gray-900 text-white text-xs rounded-lg shadow-lg p-3 right-0">
                                    <div class="font-semibold mb-2 text-gray-300">Net Effective Breakdown</div>
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Monthly Rent:</span>
                                            <span>${{ apartment.price|floatformat:2 }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Lease Term:</span>
                                            <span>{{ apartment.lease_length_months|default:12 }} months</span>
                                        </div>
                                        <div class="border-t border-gray-700 my-1.5"></div>
                                        {% if apartment.months_free %}
                                        <div class="flex justify-between text-green-400">
                                            <span>{{ apartment.months_free }} mo free:</span>
                                            <span>-$<span class="months-free-value" data-price="{{ apartment.price }}" data-months="{{ apartment.months_free }}">...</span></span>
                                        </div>
                                        {% endif %}
                                        {% if apartment.weeks_free %}
                                        <div class="flex justify-between text-green-400">
                                            <span>{{ apartment.weeks_free }} wk free:</span>
                                            <span>-$<span class="weeks-free-value" data-price="{{ apartment.price }}" data-weeks="{{ apartment.weeks_free }}">...</span></span>
                                        </div>
                                        {% endif %}
                                        {% if apartment.flat_discount %}
                                        <div class="flex justify-between text-green-400">
                                            <span>Cash discount:</span>
                                            <span>-${{ apartment.flat_discount|floatformat:2 }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="border-t border-gray-700 my-1.5"></div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Total Savings:</span>
                                            <span class="text-green-400 font-semibold total-savings" data-lease="{{ apartment.lease_length_months|default:12 }}">...</span>
                                        </div>
                                        <div class="flex justify-between font-semibold">
                                            <span>Net Effective:</span>
                                            <span class="text-green-400">${{ apartment.net_effective_price|floatformat:2 }}/mo</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-700 text-gray-500 text-[10px]">
                                        Using {{ preferences.discount_calculation|default:"weekly" }} rate calculation
                                    </div>
                                    <div class="tooltip-arrow absolute right-4 w-3 h-3 bg-gray-900 transform rotate-45"></div>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Specs Grid -->
                    <div class="border-t border-gray-100 dark:border-neutral-700 pt-3">
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Size</span>
                                <span class="font-medium text-gray-900 dark:text-white">{{ apartment.square_footage }} sqft</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">$/sqft</span>
                                <span class="font-medium text-gray-900 dark:text-white">${{ apartment.price_per_sqft|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Beds</span>
                                <span class="font-medium text-gray-900 dark:text-white">{% if apartment.bedrooms == 0 %}Studio{% else %}{{ apartment.bedrooms|floatformat:"-1" }}{% endif %}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Baths</span>
                                <span class="font-medium text-gray-900 dark:text-white">{{ apartment.bathrooms|floatformat:"-1" }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Lease & Offers -->
                    <div class="border-t border-gray-100 dark:border-neutral-700 pt-3 space-y-1.5 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Lease</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ apartment.lease_length_months }} months</span>
                        </div>
                        {% if apartment.months_free or apartment.weeks_free or apartment.flat_discount %}
                        <div class="flex justify-between">
                            <span class="text-gray-500">Offers</span>
                            <span class="font-medium text-brand-green">
                                {% if apartment.months_free %}{{ apartment.months_free }}mo free{% endif %}{% if apartment.months_free and apartment.weeks_free %}, {% endif %}{% if apartment.weeks_free %}{{ apartment.weeks_free }}wk free{% endif %}{% if apartment.flat_discount %}{% if apartment.months_free or apartment.weeks_free %}, {% endif %}${{ apartment.flat_discount|floatformat:0 }} off{% endif %}
                                <span id="card-discount-total-{{ apartment.pk|default:forloop.counter }}"></span>
                            </span>
                        </div>
                        <script>
                            (function() {
                                var totalDiscount = 0;
                                var leaseLength = {{ apartment.lease_length_months|default:12 }};
                                {% if apartment.months_free %}
                                totalDiscount += calculateDiscountAmount({{ apartment.price }}, {{ apartment.months_free }}, 'months', '{{ preferences.discount_calculation|default:"weekly" }}');
                                {% endif %}
                                {% if apartment.weeks_free %}
                                totalDiscount += calculateDiscountAmount({{ apartment.price }}, {{ apartment.weeks_free }}, 'weeks', '{{ preferences.discount_calculation|default:"weekly" }}');
                                {% endif %}
                                {% if apartment.flat_discount %}
                                totalDiscount += {{ apartment.flat_discount }};
                                {% endif %}
                                var monthlyDiscount = totalDiscount / leaseLength;
                                document.getElementById('card-discount-total-{{ apartment.pk|default:forloop.counter }}').textContent = ' ($' + monthlyDiscount.toFixed(0) + '/mo)';
                                document.getElementById('mobile-card-{{ apartment.pk|default:forloop.counter }}').setAttribute('data-discount-amount', monthlyDiscount.toFixed(2));
                            })();
                        </script>
                        {% else %}
                        <div class="flex justify-between">
                            <span class="text-gray-500">Offers</span>
                            <span class="text-gray-400">None</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Distance to Favorite Places -->
                    {% if favorite_places %}
                    <div class="border-t border-gray-100 dark:border-neutral-700 pt-3 space-y-1.5 text-sm" data-distance-container data-apartment-id="{{ apartment.pk }}">
                        {% if apartment.pk in apartments_needing_distances %}
                            <!-- Loading state - distances being calculated -->
                            <div class="flex justify-between items-center" data-distance-loading>
                                <span class="text-gray-500">Calculating distances...</span>
                                <span class="text-brand-purple">
                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </div>
                        {% elif apartment.distance_data %}
                            {% for label, info in apartment.distance_data|sort_by_time %}
                            <div class="flex justify-between items-center" data-distance-row data-place-label="{{ label }}">
                                <span class="text-gray-500 truncate mr-2">{{ label }}</span>
                                <span class="font-medium text-gray-900 dark:text-white flex-shrink-0" data-distance-value>
                                    {% if info.travel_time != None %}
                                        {{ info.travel_time }} min
                                        <span class="text-gray-500 font-normal">({{ info.distance|floatformat:1 }} mi)</span>
                                    {% elif info.distance != None %}
                                        {{ info.distance|floatformat:1 }} mi
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </span>
                            </div>
                            {% endfor %}
                            {% if favorite_place_count > 1 and apartment.average_travel_time != None %}
                            <div class="flex justify-between items-center pt-1 border-t border-gray-100 dark:border-neutral-700 mt-1" data-average-row>
                                <span class="text-gray-500 font-medium">Average</span>
                                <span class="font-semibold text-brand-purple flex-shrink-0" data-average-value>
                                    {{ apartment.average_travel_time }} min
                                    <span class="text-brand-purple/70 font-normal">({{ apartment.average_distance|floatformat:1 }} mi)</span>
                                </span>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="flex justify-between">
                                <span class="text-gray-500">Distance</span>
                                <span class="text-gray-400">Not available</span>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Card Footer: Edit/Remove -->
                <div class="px-4 py-2 border-t border-gray-100 dark:border-neutral-700 flex items-center justify-between">
                    <button onclick="openEditApartmentModal({
                        pk: '{{ apartment.pk }}',
                        name: '{{ apartment.name|escapejs }}',
                        price: {{ apartment.price }},
                        square_footage: {{ apartment.square_footage }},
                        bedrooms: {{ apartment.bedrooms|default:1 }},
                        bathrooms: {{ apartment.bathrooms|default:1 }},
                        lease_length_months: {{ apartment.lease_length_months|default:12 }},
                        months_free: {{ apartment.months_free|default:0 }},
                        weeks_free: {{ apartment.weeks_free|default:0 }},
                        flat_discount: {{ apartment.flat_discount|default:0 }}
                    })" class="text-brand-purple hover:text-brand-purple-light text-xs font-medium py-1.5 px-2 touch-manipulation">
                        Edit
                    </button>
                    {% if apartment.pk %}
                        <form action="{% url 'apartments:delete_apartment' apartment.pk %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-red-500 hover:text-red-600 text-xs font-medium py-1.5 px-2 touch-manipulation" onclick="return confirm('Are you sure you want to delete {{ apartment.name }}?')">
                                Remove
                            </button>
                        </form>
                    {% else %}
                        <button onclick='deleteSessionApartment("{{ apartment.id }}")' class="text-red-500 hover:text-red-600 text-xs font-medium py-1.5 px-2 touch-manipulation">
                            Remove
                        </button>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Table View - Desktop only -->
    <div id="tableView" class="hidden sm:block overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr class="divide-x divide-gray-200">
                    <th scope="col" class="px-6 py-3 text-left sticky-col-left">
                        <button onclick="sortTable('name')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                            Name
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </button>
                    </th>
                    {% if user.is_authenticated %}
                    <th scope="col" class="px-6 py-3 text-left bg-yellow-50 dark:bg-yellow-900/10">
                        <div class="flex items-center gap-1">
                            <button onclick="sortTable('score')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                                <svg class="mr-2 h-5 w-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                </svg>
                                Score
                                <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                            <div class="relative group/tooltip">
                                <svg class="h-4 w-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="absolute left-0 top-6 w-64 p-3 bg-gray-900 dark:bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible group-hover/tooltip:opacity-100 group-hover/tooltip:visible transition-all z-50">
                                    <p class="font-medium mb-1">Score (0-10)</p>
                                    <p class="text-gray-300">Scores are relative to the apartments you're comparing. 10 = best match for your preferences, 5 = average. Adding or removing apartments recalculates all scores.</p>
                                </div>
                            </div>
                        </div>
                    </th>
                    {% endif %}
                    <th scope="col" class="px-6 py-3 text-left">
                        <button onclick="sortTable('price')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                            Monthly Rent
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </button>
                    </th>
                    <th scope="col" id="netEffectiveHeader" class="px-6 py-3 text-left {% if not has_discounts and not is_anonymous %}hidden{% endif %}">
                        <button onclick="sortTable('net_price')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                            Net Effective
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </button>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left">
                        <button onclick="sortTable('square_footage')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                            Sq Ft
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </button>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left">
                        <button onclick="sortTable('price_per_sqft')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                            $/Sq Ft
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </button>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Lease Term
                    </th>
                    <th scope="col" id="discountsHeader" class="px-6 py-3 text-left {% if not has_discounts and not is_anonymous %}hidden{% endif %}">
                        <button onclick="sortTable('discount')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                            Discounts
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                            </svg>
                        </button>
                    </th>
                    {% if favorite_places %}
                        {% if is_premium and favorite_place_count > 1 %}
                        <th scope="col" class="px-6 py-3 text-left">
                            <button onclick="sortTable('avg_distance')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                                Avg Time
                                <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                        </th>
                        {% endif %}
                        {% for place in favorite_places %}
                        <th scope="col" class="px-6 py-3 text-left">
                            <button onclick="sortTable('distance_{{ place.label|slugify }}')" class="group inline-flex items-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:text-gray-700">
                                {{ place.label }}
                                <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </button>
                        </th>
                        {% endfor %}
                    {% endif %}
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sticky-col-right">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-neutral-800 divide-y divide-gray-200 dark:divide-neutral-700" id="apartmentsTableBody">
                {% for apartment in apartments %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-neutral-700 divide-x divide-gray-200 dark:divide-neutral-600" data-apartment-id="{{ apartment.pk }}" data-field="name">
                        <!-- Name -->
                        <td class="px-6 py-4 whitespace-nowrap sticky-col-left">
                            <div class="flex items-center flex-wrap gap-1">
                                <div class="text-sm font-medium text-gray-900" data-field="name">
                                    {{ apartment.name }}
                                </div>
                                {% if apartment.months_free or apartment.weeks_free or apartment.flat_discount %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        Deal
                                    </span>
                                {% endif %}
                                {% if apartment.address %}
                                    {% if apartment.latitude and apartment.longitude %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400" title="{{ apartment.address }}">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                            </svg>
                                            Located
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400" title="Could not find location for: {{ apartment.address }}">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                            Location N/A
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                        <!-- Score -->
                        {% if user.is_authenticated %}
                        <td class="px-6 py-4 whitespace-nowrap bg-yellow-50 dark:bg-yellow-900/10">
                            {% if apartment.score %}
                            <div class="group relative" data-score="{{ apartment.score|floatformat:1 }}">
                                <div class="flex items-center cursor-help">
                                    <span class="text-2xl font-bold
                                        {% if apartment.score >= 9 %}text-green-700{% elif apartment.score >= 7 %}text-green-600{% elif apartment.score >= 5 %}text-yellow-600{% else %}text-red-600{% endif %}"
                                        data-field="score">
                                        {{ apartment.score|floatformat:1 }}
                                    </span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400 ml-1">/10</span>
                                    <svg class="h-4 w-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                {% if apartment.score_breakdown %}
                                <div class="score-breakdown-tooltip hidden group-hover:block absolute z-50 w-64 text-xs rounded-lg shadow-lg p-3">
                                    <div class="font-semibold mb-2 text-gray-300">Score Breakdown</div>
                                    <div class="space-y-1.5">
                                        {% for factor in apartment.score_breakdown.factors %}
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300">{{ factor.name }} <span class="text-gray-500">({{ factor.weight_pct }}%)</span></span>
                                            <span class="font-medium">+{{ factor.contribution }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="border-t border-gray-700 mt-2 pt-2 flex justify-between items-center font-semibold">
                                        <span>Total</span>
                                        <span>{{ apartment.score|floatformat:1 }}/10</span>
                                    </div>
                                    <div class="tooltip-arrow absolute left-4 w-3 h-3 transform rotate-45"></div>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-400">-</div>
                            {% endif %}
                        </td>
                        {% endif %}
                        <!-- Monthly Rent -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900" data-field="price">
                                ${{ apartment.price|floatformat:2 }}
                            </div>
                        </td>
                        <!-- Net Effective -->
                        {% if has_discounts %}
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="group relative">
                                <div class="text-sm font-semibold text-green-600 cursor-help flex items-center">
                                    ${{ apartment.net_effective_price|floatformat:2 }}
                                    {% if apartment.months_free or apartment.weeks_free or apartment.flat_discount %}
                                    <svg class="w-3.5 h-3.5 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    {% endif %}
                                </div>
                                {% if apartment.months_free or apartment.weeks_free or apartment.flat_discount %}
                                <div class="net-effective-tooltip hidden group-hover:block absolute z-50 w-64 bg-gray-900 text-white text-xs rounded-lg shadow-lg p-3">
                                    <div class="font-semibold mb-2 text-gray-300">Net Effective Breakdown</div>
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Monthly Rent:</span>
                                            <span>${{ apartment.price|floatformat:2 }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Lease Term:</span>
                                            <span>{{ apartment.lease_length_months|default:12 }} months</span>
                                        </div>
                                        <div class="border-t border-gray-700 my-1.5"></div>
                                        {% if apartment.months_free %}
                                        <div class="flex justify-between text-green-400">
                                            <span>{{ apartment.months_free }} month{{ apartment.months_free|pluralize }} free:</span>
                                            <span>-$<span class="months-free-value" data-price="{{ apartment.price }}" data-months="{{ apartment.months_free }}">...</span></span>
                                        </div>
                                        {% endif %}
                                        {% if apartment.weeks_free %}
                                        <div class="flex justify-between text-green-400">
                                            <span>{{ apartment.weeks_free }} week{{ apartment.weeks_free|pluralize }} free:</span>
                                            <span>-$<span class="weeks-free-value" data-price="{{ apartment.price }}" data-weeks="{{ apartment.weeks_free }}">...</span></span>
                                        </div>
                                        {% endif %}
                                        {% if apartment.flat_discount %}
                                        <div class="flex justify-between text-green-400">
                                            <span>Cash discount:</span>
                                            <span>-${{ apartment.flat_discount|floatformat:2 }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="border-t border-gray-700 my-1.5"></div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Total Savings:</span>
                                            <span class="text-green-400 font-semibold total-savings" data-lease="{{ apartment.lease_length_months|default:12 }}">...</span>
                                        </div>
                                        <div class="flex justify-between font-semibold">
                                            <span>Net Effective:</span>
                                            <span class="text-green-400">${{ apartment.net_effective_price|floatformat:2 }}/mo</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-700 text-gray-500 text-[10px]">
                                        Using {{ preferences.discount_calculation|default:"weekly" }} rate calculation
                                    </div>
                                    <div class="tooltip-arrow absolute left-4 w-3 h-3 bg-gray-900 transform rotate-45"></div>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                        <!-- Square Footage -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900" data-field="square_footage">
                                {{ apartment.square_footage }}
                            </div>
                        </td>
                        <!-- Price per Sq Ft -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${{ apartment.price_per_sqft|floatformat:2 }}
                            </div>
                        </td>
                        <!-- Lease Term -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {{ apartment.lease_length_months }} months
                            </div>
                        </td>
                        <!-- Discounts -->
                        {% if has_discounts %}
                        <td class="px-6 py-4" id="discount-cell-{{ apartment.pk|default:forloop.counter }}" data-discount-amount="0">
                            <div class="text-sm text-gray-900">
                                {% if apartment.months_free or apartment.weeks_free or apartment.flat_discount %}
                                    <div>
                                        {% if apartment.months_free %}{{ apartment.months_free }}mo free{% endif %}{% if apartment.months_free and apartment.weeks_free %}<br>{% endif %}{% if apartment.weeks_free %}{{ apartment.weeks_free }}wk free{% endif %}{% if apartment.flat_discount %}{% if apartment.months_free or apartment.weeks_free %}<br>{% endif %}${{ apartment.flat_discount|floatformat:2 }} off{% endif %}
                                        <span id="discount-total-{{ apartment.pk|default:forloop.counter }}"></span>
                                        <script>
                                            (function() {
                                                var totalDiscount = 0;
                                                var leaseLength = {{ apartment.lease_length_months|default:12 }};
                                                {% if apartment.months_free %}
                                                totalDiscount += calculateDiscountAmount({{ apartment.price }}, {{ apartment.months_free }}, 'months', '{{ preferences.discount_calculation|default:"weekly" }}');
                                                {% endif %}
                                                {% if apartment.weeks_free %}
                                                totalDiscount += calculateDiscountAmount({{ apartment.price }}, {{ apartment.weeks_free }}, 'weeks', '{{ preferences.discount_calculation|default:"weekly" }}');
                                                {% endif %}
                                                {% if apartment.flat_discount %}
                                                totalDiscount += {{ apartment.flat_discount }};
                                                {% endif %}
                                                var monthlyDiscount = totalDiscount / leaseLength;
                                                document.getElementById('discount-total-{{ apartment.pk|default:forloop.counter }}').textContent = ' ($' + monthlyDiscount.toFixed(2) + '/mo)';
                                                // Store the discount amount for sorting
                                                document.getElementById('discount-cell-{{ apartment.pk|default:forloop.counter }}').setAttribute('data-discount-amount', monthlyDiscount.toFixed(2));
                                            })();
                                        </script>
                                    </div>
                                {% else %}
                                    <span class="text-gray-400">None</span>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                        <!-- Distance columns -->
                        {% if favorite_places %}
                            {% if is_premium and favorite_place_count > 1 %}
                            <td class="px-6 py-4 whitespace-nowrap" data-field="avg_distance" data-avg-distance="{{ apartment.average_travel_time|default:'999' }}" data-apartment-id="{{ apartment.pk }}">
                                <div class="text-sm font-semibold text-brand-purple" data-table-avg-value>
                                    {% if apartment.pk in apartments_needing_distances %}
                                        <svg class="animate-spin h-4 w-4 text-brand-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    {% elif apartment.average_travel_time != None %}
                                        {{ apartment.average_travel_time }} min
                                        <div class="text-xs text-brand-purple/70">{{ apartment.average_distance|floatformat:1 }} mi</div>
                                    {% elif apartment.average_distance != None %}
                                        {{ apartment.average_distance|floatformat:1 }} mi
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </div>
                            </td>
                            {% endif %}
                            {% for place in favorite_places %}
                            <td class="px-6 py-4 whitespace-nowrap" data-distance-{{ place.label|slugify }}="{% with distance_info=apartment.distance_data|default_if_none:"" %}{% if distance_info and place.label in distance_info %}{% for label, info in distance_info.items %}{% if label == place.label %}{% if info.travel_time != None %}{{ info.travel_time }}{% elif info.distance != None %}999{% else %}9999{% endif %}{% endif %}{% endfor %}{% else %}9999{% endif %}{% endwith %}" data-apartment-id="{{ apartment.pk }}" data-place-label="{{ place.label }}">
                                <div class="text-sm text-gray-900 dark:text-white" data-table-distance-value>
                                    {% if apartment.pk in apartments_needing_distances %}
                                        <svg class="animate-spin h-4 w-4 text-brand-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    {% else %}
                                    {% with distance_info=apartment.distance_data|default_if_none:"" %}
                                        {% if distance_info and place.label in distance_info and distance_info|length > 0 %}
                                            {% for label, info in distance_info.items %}
                                                {% if label == place.label %}
                                                    {% if info.travel_time != None %}
                                                        {{ info.travel_time }} min
                                                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ info.distance|floatformat:1 }} mi</div>
                                                        {% if info.transit_fare %}
                                                            <div class="text-xs text-green-600 dark:text-green-400">${{ info.transit_fare|floatformat:2 }} fare</div>
                                                        {% endif %}
                                                    {% elif info.distance != None %}
                                                        {{ info.distance|floatformat:1 }} mi
                                                    {% else %}
                                                        <span class="text-gray-400">N/A</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-gray-400">N/A</span>
                                        {% endif %}
                                    {% endwith %}
                                    {% endif %}
                                </div>
                            </td>
                            {% endfor %}
                        {% endif %}
                        <!-- Actions -->
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium sticky-col-right">
                            <button onclick="openEditApartmentModal({
                                pk: '{{ apartment.pk }}',
                                name: '{{ apartment.name|escapejs }}',
                                address: '{{ apartment.address|default:""|escapejs }}',
                                price: {{ apartment.price }},
                                square_footage: {{ apartment.square_footage }},
                                bedrooms: {{ apartment.bedrooms|default:1 }},
                                bathrooms: {{ apartment.bathrooms|default:1 }},
                                lease_length_months: {{ apartment.lease_length_months|default:12 }},
                                months_free: {{ apartment.months_free|default:0 }},
                                weeks_free: {{ apartment.weeks_free|default:0 }},
                                flat_discount: {{ apartment.flat_discount|default:0 }}
                            })" class="text-brand-purple hover:text-brand-purple-light mr-2 p-2 touch-manipulation inline-flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            {% if apartment.pk %}
                                <form action="{% url 'apartments:delete_apartment' apartment.pk %}" method="post" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-600 hover:text-red-700 p-2 touch-manipulation inline-flex items-center justify-center" onclick="return confirm('Are you sure you want to delete {{ apartment.name }}?')">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </form>
                            {% else %}
                                <button onclick='deleteSessionApartment("{{ apartment.id }}")' class="text-red-600 hover:text-red-700 p-2 touch-manipulation inline-flex items-center justify-center">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<!-- Add Apartment Modal -->
<div id="addApartmentModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-0 px-0 pb-0 text-center sm:block sm:p-0 sm:pt-4 sm:px-4 sm:pb-20">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" aria-hidden="true" onclick="closeAddApartmentModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-none sm:rounded-xl text-left overflow-hidden shadow-xl transform transition-all w-full h-full sm:h-auto sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <form id="addApartmentForm" onsubmit="handleAddApartment(event)">
                {% csrf_token %}
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-brand-purple/10 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-brand-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Add New Apartment</h3>
                                    <p class="text-sm text-gray-500">Enter apartment details to compare</p>
                                </div>
                            </div>
                            <button type="button" onclick="closeAddApartmentModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Error Alert -->
                    <div id="addApartmentError" class="hidden mb-4 bg-red-50 border-l-4 border-red-400 p-4 rounded-r-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-red-800" id="addApartmentErrorMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="modal_name" class="block text-sm font-medium text-gray-700 mb-2">Apartment Name</label>
                            <input type="text" name="name" id="modal_name" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                   placeholder="e.g., The Grand at 5th">
                        </div>
                        <div>
                            <label for="modal_price" class="block text-sm font-medium text-gray-700 mb-2">Monthly Rent ($)</label>
                            <input type="number" name="price" id="modal_price" required step="0.01"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                   placeholder="e.g., 2500">
                        </div>
                        <div>
                            <label for="modal_square_footage" class="block text-sm font-medium text-gray-700 mb-2">Square Footage</label>
                            <input type="number" name="square_footage" id="modal_square_footage" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                   placeholder="e.g., 850">
                        </div>
                        <div>
                            <label for="modal_bedrooms" class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
                            <select name="bedrooms" id="modal_bedrooms"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent">
                                <option value="0">Studio</option>
                                {% for i in "123456789"|make_list %}<option value="{{ i }}"{% if i == "1" %} selected{% endif %}>{{ i }}</option>{% endfor %}
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                            </select>
                        </div>
                        <div>
                            <label for="modal_bathrooms" class="block text-sm font-medium text-gray-700 mb-2">Bathrooms</label>
                            <select name="bathrooms" id="modal_bathrooms"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent">
                                <option value="0.5">0.5</option>
                                <option value="1" selected>1</option>
                                <option value="1.5">1.5</option>
                                <option value="2">2</option>
                                <option value="2.5">2.5</option>
                                <option value="3">3</option>
                                <option value="3.5">3.5</option>
                                <option value="4">4</option>
                                <option value="4.5">4.5</option>
                                <option value="5">5</option>
                                <option value="5.5">5.5</option>
                                <option value="6">6</option>
                                <option value="6.5">6.5</option>
                                <option value="7">7</option>
                                <option value="7.5">7.5</option>
                                <option value="8">8</option>
                                <option value="8.5">8.5</option>
                                <option value="9">9</option>
                                <option value="9.5">9.5</option>
                                <option value="10">10</option>
                                <option value="10.5">10.5</option>
                                <option value="11">11</option>
                                <option value="11.5">11.5</option>
                                <option value="12">12</option>
                                <option value="12.5">12.5</option>
                                <option value="13">13</option>
                                <option value="13.5">13.5</option>
                                <option value="14">14</option>
                                <option value="14.5">14.5</option>
                                <option value="15">15</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address Field -->
                    <div class="mb-4">
                        <label for="modal_address" class="block text-sm font-medium text-gray-700 mb-2">
                            Address <span class="text-gray-400 font-normal">(optional, for distance calculations)</span>
                        </label>
                        <input type="text" name="address" id="modal_address"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                               placeholder="Start typing an address or place name..."
                               data-address-autocomplete="true"
                               autocomplete="off">
                        <!-- Hidden fields for Google Places coordinates -->
                        <input type="hidden" name="google_latitude" id="modal_google_latitude">
                        <input type="hidden" name="google_longitude" id="modal_google_longitude">
                        <input type="hidden" name="google_place_id" id="modal_google_place_id">
                    </div>

                    <!-- Advanced Options Toggle -->
                    <div class="mb-4">
                        <button type="button" onclick="toggleModalAdvancedOptions()"
                                class="flex items-center text-sm font-medium text-brand-purple hover:text-brand-purple-light transition-colors">
                            <svg id="modalAdvancedChevron" class="w-4 h-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            More options (lease length, discounts)
                        </button>
                    </div>

                    <!-- Advanced Fields (Hidden by Default) -->
                    <div id="modalAdvancedOptions" class="hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-900 mb-4">Additional Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="modal_lease_length_months" class="block text-sm font-medium text-gray-700 mb-2">Lease Length (months)</label>
                                <input type="number" name="lease_length_months" id="modal_lease_length_months" value="12"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="12">
                            </div>
                            <div>
                                <label for="modal_months_free" class="block text-sm font-medium text-gray-700 mb-2">Months Free</label>
                                <input type="number" name="months_free" id="modal_months_free" value="0"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="0">
                            </div>
                            <div>
                                <label for="modal_weeks_free" class="block text-sm font-medium text-gray-700 mb-2">Weeks Free</label>
                                <input type="number" name="weeks_free" id="modal_weeks_free" value="0"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="0">
                            </div>
                            <div>
                                <label for="modal_flat_discount" class="block text-sm font-medium text-gray-700 mb-2">Flat Discount ($)</label>
                                <input type="number" name="flat_discount" id="modal_flat_discount" value="0" step="0.01"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse border-t border-gray-200">
                    <button type="submit" class="w-full inline-flex justify-center items-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-brand-purple text-sm font-medium text-white hover:bg-brand-purple-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-purple transition-colors sm:ml-3 sm:w-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Apartment
                    </button>
                    <button type="button" onclick="closeAddApartmentModal()" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-purple transition-colors sm:mt-0 sm:w-auto">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden Preferences Form (used by Score Weights modal) -->
<form id="preferencesForm" method="post" action="{% url 'apartments:dashboard' %}" class="hidden">
    {% csrf_token %}
    <input type="hidden" name="price_weight" value="{{ preferences.price_weight|default:50 }}">
    <input type="hidden" name="sqft_weight" value="{{ preferences.sqft_weight|default:50 }}">
    <input type="hidden" name="distance_weight" value="{{ preferences.distance_weight|default:50 }}">
    <input type="hidden" name="net_rent_weight" value="{{ preferences.net_rent_weight|default:0 }}">
    <input type="hidden" name="bedrooms_weight" value="{{ preferences.bedrooms_weight|default:0 }}">
    <input type="hidden" name="bathrooms_weight" value="{{ preferences.bathrooms_weight|default:0 }}">
    <input type="hidden" name="discount_weight" value="{{ preferences.discount_weight|default:0 }}">
    <input type="hidden" name="factor_order" value="{{ preferences.factor_order|default:'price,sqft,distance,netRent,bedrooms,bathrooms,discount' }}">
    <input type="hidden" name="discount_calculation" value="{{ preferences.discount_calculation|default:'weekly' }}">
</form>

<!-- Edit Apartment Modal -->
<div id="editApartmentModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-0 px-0 pb-0 text-center sm:block sm:p-0 sm:pt-4 sm:px-4 sm:pb-20">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" aria-hidden="true" onclick="closeEditApartmentModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-none sm:rounded-xl text-left overflow-hidden shadow-xl transform transition-all w-full h-full sm:h-auto sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <form id="editApartmentForm" onsubmit="handleEditApartment(event)">
                {% csrf_token %}
                <input type="hidden" id="edit_apartment_id" name="apartment_id">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-brand-purple/10 rounded-lg flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-brand-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Edit Apartment</h3>
                                    <p class="text-sm text-gray-500">Update apartment details</p>
                                </div>
                            </div>
                            <button type="button" onclick="closeEditApartmentModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Error Alert -->
                    <div id="editApartmentError" class="hidden mb-4 bg-red-50 border-l-4 border-red-400 p-4 rounded-r-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-red-800" id="editApartmentErrorMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="edit_name" class="block text-sm font-medium text-gray-700 mb-2">Apartment Name</label>
                            <input type="text" name="name" id="edit_name" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                   placeholder="e.g., The Grand at 5th">
                        </div>
                        <div>
                            <label for="edit_price" class="block text-sm font-medium text-gray-700 mb-2">Monthly Rent ($)</label>
                            <input type="number" name="price" id="edit_price" required step="0.01"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                   placeholder="e.g., 2500">
                        </div>
                        <div>
                            <label for="edit_square_footage" class="block text-sm font-medium text-gray-700 mb-2">Square Footage</label>
                            <input type="number" name="square_footage" id="edit_square_footage" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                   placeholder="e.g., 850">
                        </div>
                        <div>
                            <label for="edit_bedrooms" class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
                            <select name="bedrooms" id="edit_bedrooms"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent">
                                <option value="0">Studio</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit_bathrooms" class="block text-sm font-medium text-gray-700 mb-2">Bathrooms</label>
                            <select name="bathrooms" id="edit_bathrooms"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent">
                                <option value="0.5">0.5</option>
                                <option value="1">1</option>
                                <option value="1.5">1.5</option>
                                <option value="2">2</option>
                                <option value="2.5">2.5</option>
                                <option value="3">3</option>
                                <option value="3.5">3.5</option>
                                <option value="4">4</option>
                                <option value="4.5">4.5</option>
                                <option value="5">5</option>
                                <option value="5.5">5.5</option>
                                <option value="6">6</option>
                                <option value="6.5">6.5</option>
                                <option value="7">7</option>
                                <option value="7.5">7.5</option>
                                <option value="8">8</option>
                                <option value="8.5">8.5</option>
                                <option value="9">9</option>
                                <option value="9.5">9.5</option>
                                <option value="10">10</option>
                                <option value="10.5">10.5</option>
                                <option value="11">11</option>
                                <option value="11.5">11.5</option>
                                <option value="12">12</option>
                                <option value="12.5">12.5</option>
                                <option value="13">13</option>
                                <option value="13.5">13.5</option>
                                <option value="14">14</option>
                                <option value="14.5">14.5</option>
                                <option value="15">15</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address Field -->
                    <div class="mb-4">
                        <label for="edit_address" class="block text-sm font-medium text-gray-700 mb-2">
                            Address <span class="text-gray-400 font-normal">(optional, for distance calculations)</span>
                        </label>
                        <input type="text" name="address" id="edit_address"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                               placeholder="Start typing an address or place name..."
                               data-address-autocomplete="true"
                               autocomplete="off">
                        <!-- Hidden fields for Google Places coordinates -->
                        <input type="hidden" name="google_latitude" id="edit_google_latitude">
                        <input type="hidden" name="google_longitude" id="edit_google_longitude">
                        <input type="hidden" name="google_place_id" id="edit_google_place_id">
                    </div>

                    <!-- Advanced Options Toggle -->
                    <div class="mb-4">
                        <button type="button" onclick="toggleEditAdvancedOptions()"
                                class="flex items-center text-sm font-medium text-brand-purple hover:text-brand-purple-light transition-colors">
                            <svg id="editAdvancedChevron" class="w-4 h-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            More options (lease length, discounts)
                        </button>
                    </div>

                    <!-- Advanced Fields (Hidden by Default) -->
                    <div id="editAdvancedOptions" class="hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-900 mb-4">Additional Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_lease_length_months" class="block text-sm font-medium text-gray-700 mb-2">Lease Length (months)</label>
                                <input type="number" name="lease_length_months" id="edit_lease_length_months" value="12"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="12">
                            </div>
                            <div>
                                <label for="edit_months_free" class="block text-sm font-medium text-gray-700 mb-2">Months Free</label>
                                <input type="number" name="months_free" id="edit_months_free" value="0"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="0">
                            </div>
                            <div>
                                <label for="edit_weeks_free" class="block text-sm font-medium text-gray-700 mb-2">Weeks Free</label>
                                <input type="number" name="weeks_free" id="edit_weeks_free" value="0"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="0">
                            </div>
                            <div>
                                <label for="edit_flat_discount" class="block text-sm font-medium text-gray-700 mb-2">Flat Discount ($)</label>
                                <input type="number" name="flat_discount" id="edit_flat_discount" value="0" step="0.01"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple focus:border-transparent"
                                       placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:flex sm:flex-row-reverse border-t border-gray-200">
                    <button type="submit" class="w-full inline-flex justify-center items-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-brand-purple text-sm font-medium text-white hover:bg-brand-purple-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-purple transition-colors sm:ml-3 sm:w-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Update Apartment
                    </button>
                    <button type="button" onclick="closeEditApartmentModal()" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-purple transition-colors sm:mt-0 sm:w-auto">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Premium status from backend
const isPremium = {{ is_premium|lower }};

// User preferences
const userPreferences = {
    priceWeight: {{ preferences.price_weight|default:50 }},
    sqftWeight: {{ preferences.sqft_weight|default:50 }},
    distanceWeight: {{ preferences.distance_weight|default:50 }},
    netRentWeight: {{ preferences.net_rent_weight|default:0 }},
    bedroomsWeight: {{ preferences.bedrooms_weight|default:0 }},
    bathroomsWeight: {{ preferences.bathrooms_weight|default:0 }},
    discountWeight: {{ preferences.discount_weight|default:0 }},
    factorOrder: "{{ preferences.factor_order|default:'price,sqft,distance,netRent,bedrooms,bathrooms,discount' }}"
};

// SessionStorage management for anonymous users
function getSessionApartments() {
    const apartments = sessionStorage.getItem('anonymous_apartments');
    return apartments ? JSON.parse(apartments) : [];
}

function saveSessionApartments(apartments) {
    sessionStorage.setItem('anonymous_apartments', JSON.stringify(apartments));
}

// Calculate net effective price
function calculateNetEffectivePrice(apartment) {
    const price = parseFloat(apartment.price);
    const leaseLength = parseInt(apartment.lease_length_months || 12);
    const monthsFree = parseInt(apartment.months_free || 0);
    const weeksFree = parseInt(apartment.weeks_free || 0);
    const flatDiscount = parseFloat(apartment.flat_discount || 0);

    // Get discount calculation method from user preferences
    const discountCalcMethod = '{{ preferences.discount_calculation|default:"weekly" }}';

    let totalDiscount = 0;
    const annualRent = price * 12;

    if (discountCalcMethod === 'daily') {
        // Calculate using daily rate (annual rent / 365 days)
        const dailyRate = annualRent / 365;

        // Convert months to days (365/12 = ~30.42 days per month)
        if (monthsFree > 0) {
            const daysFromMonths = monthsFree * (365 / 12);
            totalDiscount += dailyRate * daysFromMonths;
        }

        // Convert weeks to days
        if (weeksFree > 0) {
            totalDiscount += dailyRate * weeksFree * 7;
        }
    } else if (discountCalcMethod === 'weekly') {
        // Calculate using weekly rate (annual rent / 52 weeks)
        const weeklyRate = annualRent / 52;

        // Convert months to weeks (52/12 = ~4.33 weeks per month)
        if (monthsFree > 0) {
            const weeksFromMonths = monthsFree * (52 / 12);
            totalDiscount += weeklyRate * weeksFromMonths;
        }

        // Add weeks directly
        if (weeksFree > 0) {
            totalDiscount += weeklyRate * weeksFree;
        }
    } else {
        // Fallback to monthly calculation
        if (monthsFree > 0) {
            totalDiscount += price * monthsFree;
        }
        if (weeksFree > 0) {
            totalDiscount += price * (weeksFree / 4);
        }
    }

    // Add flat discount
    totalDiscount += flatDiscount;

    // Calculate net effective price
    const totalRent = price * leaseLength;
    const netTotal = totalRent - totalDiscount;
    const netEffectivePrice = netTotal / leaseLength;

    return netEffectivePrice;
}

// Load and display apartments for anonymous users
function loadAnonymousApartments() {
    const isAnonymous = {{ is_anonymous|yesno:"true,false" }};
    if (!isAnonymous) return;

    const apartments = getSessionApartments();
    const apartmentCount = apartments.length;

    // Update apartment count display
    const countText = document.getElementById('apartmentCountText');
    if (countText) {
        countText.textContent = `${apartmentCount} apartment${apartmentCount !== 1 ? 's' : ''} compared`;
    }

    // Update apartment count badge
    const badge = document.getElementById('apartmentCountBadge');
    const badgeText = document.getElementById('apartmentCountBadgeText');
    if (badge && badgeText) {
        if (apartmentCount >= 2) {
            badge.className = 'ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
            badgeText.textContent = 'Limit reached';
        } else if (apartmentCount >= 1) {
            badge.className = 'ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800';
            badgeText.textContent = `${apartmentCount}/2 used`;
        } else {
            badge.className = 'ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            badgeText.textContent = 'Free tier';
        }
    }

    // Check if any apartment has discounts
    const hasDiscounts = apartments.some(apt =>
        (apt.months_free && apt.months_free > 0) ||
        (apt.weeks_free && apt.weeks_free > 0) ||
        (apt.flat_discount && apt.flat_discount > 0)
    );

    // Show/hide discount columns in table header based on whether any apartment has discounts
    const netEffectiveHeader = document.getElementById('netEffectiveHeader');
    const discountsHeader = document.getElementById('discountsHeader');
    if (netEffectiveHeader && discountsHeader) {
        if (hasDiscounts) {
            netEffectiveHeader.classList.remove('hidden');
            discountsHeader.classList.remove('hidden');
        } else {
            netEffectiveHeader.classList.add('hidden');
            discountsHeader.classList.add('hidden');
        }
    }

    // Render apartments in table view
    const tableBody = document.getElementById('apartmentsTableBody');
    if (tableBody) {
        const discountCalcMethod = '{{ preferences.discount_calculation|default:"weekly" }}';
        tableBody.innerHTML = apartments.map(apartment => {
            const netEffectivePrice = calculateNetEffectivePrice(apartment);
            const hasDeal = (apartment.months_free && apartment.months_free > 0) ||
                           (apartment.weeks_free && apartment.weeks_free > 0) ||
                           (apartment.flat_discount && apartment.flat_discount > 0);

            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-neutral-700 divide-x divide-gray-200 dark:divide-neutral-600" data-apartment-id="${apartment.id}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${apartment.name}</div>
                            ${hasDeal ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Deal</span>' : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${parseFloat(apartment.price).toFixed(2)}</div>
                    </td>
                    ${hasDiscounts ? `<td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-green-600">$${netEffectivePrice.toFixed(2)}</div>
                    </td>` : ''}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${apartment.square_footage} sq ft</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">$${(parseFloat(apartment.price) / parseInt(apartment.square_footage)).toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${apartment.lease_length_months || 12} months</div>
                    </td>
                    ${hasDiscounts ? (() => {
                        let parts = [];
                        let totalDiscount = 0;
                        const leaseLength = apartment.lease_length_months || 12;

                        if (apartment.months_free) {
                            parts.push(`${apartment.months_free}mo free`);
                            totalDiscount += calculateDiscountAmount(apartment.price, apartment.months_free, 'months', discountCalcMethod);
                        }
                        if (apartment.weeks_free) {
                            parts.push(`${apartment.weeks_free}wk free`);
                            totalDiscount += calculateDiscountAmount(apartment.price, apartment.weeks_free, 'weeks', discountCalcMethod);
                        }
                        if (apartment.flat_discount) {
                            parts.push(`$${parseFloat(apartment.flat_discount).toFixed(2)} off`);
                            totalDiscount += parseFloat(apartment.flat_discount);
                        }

                        const monthlyDiscount = totalDiscount / leaseLength;
                        const discountText = parts.length > 0 ? parts.join('<br>') + ` ($${monthlyDiscount.toFixed(2)}/mo)` : '<span class="text-gray-400">None</span>';

                        return `<td class="px-6 py-4" data-discount-amount="${monthlyDiscount.toFixed(2)}">
                            <div class="text-sm text-gray-900">
                                ${discountText}
                            </div>
                        </td>`;
                    })() : ''}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='openEditApartmentModal(${JSON.stringify(apartment)})' class="text-brand-purple hover:text-brand-purple-light mr-2 p-2 touch-manipulation inline-flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteSessionApartment('${apartment.id}')" class="text-red-600 hover:text-red-700 p-2 touch-manipulation inline-flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Render apartments in card view
    const cardView = document.getElementById('cardView');
    if (cardView) {
        const discountCalcMethod = '{{ preferences.discount_calculation|default:"weekly" }}';
        const cardsHTML = apartments.map(apartment => {
            const netEffectivePrice = calculateNetEffectivePrice(apartment);
            const hasDeal = (apartment.months_free && apartment.months_free > 0) ||
                           (apartment.weeks_free && apartment.weeks_free > 0) ||
                           (apartment.flat_discount && apartment.flat_discount > 0);

            return `
                <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-gray-200 dark:border-neutral-700 hover:shadow-md transition-shadow duration-200">
                    <div class="px-6 py-4 border-b border-gray-100 dark:border-neutral-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${apartment.name}</h3>
                            ${hasDeal ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Deal</span>' : ''}
                        </div>
                    </div>
                    <div class="px-6 py-4 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Monthly Rent</span>
                            <span class="text-lg font-semibold text-gray-900">$${parseFloat(apartment.price).toFixed(2)}</span>
                        </div>
                        ${hasDiscounts ? `<div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Net Effective</span>
                            <span class="text-lg font-semibold text-green-600">$${netEffectivePrice.toFixed(2)}</span>
                        </div>` : ''}
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Square Footage</span>
                            <span class="text-sm font-medium text-gray-900">${apartment.square_footage} sq ft</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Price/sq ft</span>
                            <span class="text-sm font-medium text-gray-900">$${(parseFloat(apartment.price) / parseInt(apartment.square_footage)).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Lease term</span>
                            <span class="text-sm font-medium text-gray-900">${apartment.lease_length_months || 12} months</span>
                        </div>
                        ${hasDeal ? `<div class="pt-2 border-t border-gray-100">
                            <span class="text-xs text-gray-500">Discounts:</span>
                            <div class="text-sm text-gray-900">
                                ${(() => {
                                    let parts = [];
                                    let totalDiscount = 0;
                                    const leaseLength = apartment.lease_length_months || 12;

                                    if (apartment.months_free) {
                                        parts.push(`${apartment.months_free} month${apartment.months_free > 1 ? 's' : ''} free`);
                                        totalDiscount += calculateDiscountAmount(apartment.price, apartment.months_free, 'months', discountCalcMethod);
                                    }
                                    if (apartment.weeks_free) {
                                        parts.push(`${apartment.weeks_free} week${apartment.weeks_free > 1 ? 's' : ''} free`);
                                        totalDiscount += calculateDiscountAmount(apartment.price, apartment.weeks_free, 'weeks', discountCalcMethod);
                                    }
                                    if (apartment.flat_discount) {
                                        parts.push(`$${parseFloat(apartment.flat_discount).toFixed(2)} off`);
                                        totalDiscount += parseFloat(apartment.flat_discount);
                                    }

                                    const monthlyDiscount = totalDiscount / leaseLength;
                                    return parts.join('<br>') + ` ($${monthlyDiscount.toFixed(2)}/mo)`;
                                })()}
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 rounded-b-xl">
                        <div class="flex items-center justify-between gap-3">
                            <button onclick='openEditApartmentModal(${JSON.stringify(apartment)})' class="text-brand-purple hover:text-brand-purple-light text-sm font-medium py-2 px-3 touch-manipulation min-h-[44px] flex items-center">
                                Edit details
                            </button>
                            <button onclick="deleteSessionApartment('${apartment.id}')" class="text-red-600 hover:text-red-700 text-sm font-medium py-2 px-3 touch-manipulation min-h-[44px]">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Replace the Django-rendered cards with sessionStorage apartments
        cardView.innerHTML = cardsHTML;
    }
}

// Add apartment to sessionStorage
function addSessionApartment(apartmentData) {
    const apartments = getSessionApartments();
    apartmentData.id = `session_${apartments.length}_${apartmentData.name.replace(/\s+/g, '_')}`;
    apartments.push(apartmentData);
    saveSessionApartments(apartments);
    return apartmentData;
}

// Delete apartment from sessionStorage
async function deleteSessionApartment(apartmentId) {
    if (!confirm('Are you sure you want to delete this apartment?')) {
        return;
    }

    const apartments = getSessionApartments();
    const filtered = apartments.filter(apt => apt.id !== apartmentId);
    saveSessionApartments(filtered);

    // Check if there are remaining apartments
    if (filtered.length > 0) {
        // Stay on dashboard - reload to update view
        window.location.reload();
    } else {
        // No apartments left - redirect to homepage
        window.location.href = '{% url "apartments:index" %}';
    }
}

// Modal functions
function openAddApartmentModal() {
    document.getElementById('addApartmentModal').classList.remove('hidden');
}

function closeAddApartmentModal() {
    document.getElementById('addApartmentModal').classList.add('hidden');
    // Reset form
    document.getElementById('addApartmentForm').reset();
    // Hide error message
    document.getElementById('addApartmentError').classList.add('hidden');
    // Hide advanced options
    const advancedOptions = document.getElementById('modalAdvancedOptions');
    const chevron = document.getElementById('modalAdvancedChevron');
    advancedOptions.classList.add('hidden');
    chevron.classList.remove('rotate-180');
}

function toggleModalAdvancedOptions() {
    const advancedOptions = document.getElementById('modalAdvancedOptions');
    const chevron = document.getElementById('modalAdvancedChevron');

    if (advancedOptions.classList.contains('hidden')) {
        advancedOptions.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        advancedOptions.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

// Handle add apartment form submission
async function handleAddApartment(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const isAnonymous = {{ is_anonymous|yesno:"true,false" }};

    if (isAnonymous) {
        // Store in sessionStorage for anonymous users
        const apartments = getSessionApartments();

        // Check 2-apartment limit for anonymous users
        if (apartments.length >= 2) {
            alert('You\'ve reached the 2-apartment limit for guest users. Sign up to save and compare more apartments!');
            window.location.href = '{% url "signup" %}?next=/apartments/dashboard/';
            return;
        }

        const apartmentData = {
            name: formData.get('name'),
            price: parseFloat(formData.get('price')),
            square_footage: parseInt(formData.get('square_footage')),
            bedrooms: parseFloat(formData.get('bedrooms') || 1),
            bathrooms: parseFloat(formData.get('bathrooms') || 1),
            lease_length_months: parseInt(formData.get('lease_length_months') || 12),
            months_free: parseInt(formData.get('months_free') || 0),
            weeks_free: parseInt(formData.get('weeks_free') || 0),
            flat_discount: parseFloat(formData.get('flat_discount') || 0)
        };

        addSessionApartment(apartmentData);
        closeAddApartmentModal();
        window.location.reload();
    } else {
        // Authenticated user - save to server
        try {
            const response = await fetch('{% url "apartments:create_apartment" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (response.ok) {
                closeAddApartmentModal();
                window.location.reload();
            } else {
                const errorText = await response.text();
                alert('Failed to add apartment. Please check your inputs and try again.');
                console.error('Error:', errorText);
            }
        } catch (error) {
            alert('An error occurred while adding the apartment.');
            console.error('Error:', error);
        }
    }
}

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Mobile card sorting - combines field and order dropdowns
function updateMobileSort() {
    const fieldSelect = document.getElementById('mobileSortField');
    const orderSelect = document.getElementById('mobileSortOrder');
    if (!fieldSelect || !orderSelect) return;

    const field = fieldSelect.value;
    const order = orderSelect.value;
    const sortValue = field + '-' + order;

    sortMobileCards(sortValue);

    // Save preferences
    localStorage.setItem('mobileSortField', field);
    localStorage.setItem('mobileSortOrder', order);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAnonymousApartments();

    // Restore mobile sort preferences
    const savedField = localStorage.getItem('mobileSortField');
    const savedOrder = localStorage.getItem('mobileSortOrder');

    const fieldSelect = document.getElementById('mobileSortField');
    const orderSelect = document.getElementById('mobileSortOrder');

    if (fieldSelect && savedField) {
        fieldSelect.value = savedField;
    }
    if (orderSelect && savedOrder) {
        orderSelect.value = savedOrder;
    }

    // Only apply sort if user has saved a different preference than the default (score-desc)
    // Server already sends cards sorted by score, so we don't need to re-sort
    if (fieldSelect && orderSelect && savedField && (savedField !== 'score' || savedOrder !== 'desc')) {
        updateMobileSort();
    }

    // Calculate tooltip discount values
    calculateTooltipValues();

    // Position tooltips dynamically
    setupTooltipPositioning();

    // Hide favorite places prompt if previously dismissed
    if (localStorage.getItem('favoritePlacesPromptDismissed') === 'true') {
        const prompt = document.getElementById('favoritePlacesPrompt');
        if (prompt) prompt.style.display = 'none';
    }
});

function calculateTooltipValues() {
    const discountCalcMethod = '{{ preferences.discount_calculation|default:"weekly" }}';

    // Calculate months free values
    document.querySelectorAll('.months-free-value').forEach(el => {
        const price = parseFloat(el.dataset.price);
        const months = parseFloat(el.dataset.months);
        const discount = calculateDiscountAmount(price, months, 'months', discountCalcMethod);
        el.textContent = discount.toFixed(2);
    });

    // Calculate weeks free values
    document.querySelectorAll('.weeks-free-value').forEach(el => {
        const price = parseFloat(el.dataset.price);
        const weeks = parseFloat(el.dataset.weeks);
        const discount = calculateDiscountAmount(price, weeks, 'weeks', discountCalcMethod);
        el.textContent = discount.toFixed(2);
    });

    // Calculate total savings for each tooltip
    document.querySelectorAll('.total-savings').forEach(el => {
        const tooltip = el.closest('.space-y-1\\.5');
        if (!tooltip) return;

        let totalDiscount = 0;
        const leaseLength = parseInt(el.dataset.lease) || 12;

        // Sum months free
        const monthsEl = tooltip.querySelector('.months-free-value');
        if (monthsEl) {
            totalDiscount += parseFloat(monthsEl.textContent) || 0;
        }

        // Sum weeks free
        const weeksEl = tooltip.querySelector('.weeks-free-value');
        if (weeksEl) {
            totalDiscount += parseFloat(weeksEl.textContent) || 0;
        }

        // Sum flat discount (look for the cash discount row)
        const rows = tooltip.querySelectorAll('.flex.justify-between');
        rows.forEach(row => {
            const label = row.querySelector('span:first-child');
            if (label && label.textContent.includes('Cash discount')) {
                const valueSpan = row.querySelector('span:last-child');
                if (valueSpan) {
                    const match = valueSpan.textContent.match(/\$([\d,]+\.?\d*)/);
                    if (match) {
                        totalDiscount += parseFloat(match[1].replace(/,/g, ''));
                    }
                }
            }
        });

        const monthlySavings = totalDiscount / leaseLength;
        el.textContent = '$' + totalDiscount.toFixed(2) + ' ($' + monthlySavings.toFixed(2) + '/mo)';
    });
}

function setupTooltipPositioning() {
    // Find all tooltip trigger groups
    document.querySelectorAll('.group.relative').forEach(group => {
        const tooltip = group.querySelector('.net-effective-tooltip') || group.querySelector('.score-breakdown-tooltip');
        if (!tooltip) return;

        const arrow = tooltip.querySelector('.tooltip-arrow');

        group.addEventListener('mouseenter', function() {
            // Use fixed positioning to escape overflow containers
            const groupRect = group.getBoundingClientRect();

            // Temporarily show tooltip to measure it
            tooltip.style.visibility = 'hidden';
            tooltip.style.display = 'block';
            tooltip.style.position = 'fixed';

            const tooltipHeight = tooltip.offsetHeight;
            const tooltipWidth = tooltip.offsetWidth;

            // Check if there's enough space above
            const spaceAbove = groupRect.top;
            const spaceBelow = window.innerHeight - groupRect.bottom;

            // Calculate left position (align with trigger, but keep on screen)
            let leftPos = groupRect.left;
            if (leftPos + tooltipWidth > window.innerWidth - 10) {
                leftPos = window.innerWidth - tooltipWidth - 10;
            }

            tooltip.style.left = leftPos + 'px';
            tooltip.style.visibility = '';

            if (spaceAbove < tooltipHeight + 20) {
                // Not enough space above, show below
                tooltip.style.top = (groupRect.bottom + 8) + 'px';
                tooltip.style.bottom = 'auto';
                if (arrow) {
                    arrow.style.top = '-6px';
                    arrow.style.bottom = 'auto';
                }
            } else {
                // Show above
                tooltip.style.top = (groupRect.top - tooltipHeight - 8) + 'px';
                tooltip.style.bottom = 'auto';
                if (arrow) {
                    arrow.style.bottom = '-6px';
                    arrow.style.top = 'auto';
                }
            }
        });

        group.addEventListener('mouseleave', function() {
            // Reset tooltip positioning
            tooltip.style.position = '';
            tooltip.style.top = '';
            tooltip.style.left = '';
            tooltip.style.display = '';
        });
    });
}


function dismissSignupPrompt() {
    const prompt = document.getElementById('signupPrompt');
    if (prompt) {
        prompt.style.display = 'none';
        sessionStorage.setItem('signupPromptDismissed', 'true');
    }
}

function dismissUpgradePrompt() {
    const prompt = document.getElementById('upgradePrompt');
    if (prompt) {
        prompt.style.display = 'none';
        sessionStorage.setItem('upgradePromptDismissed', 'true');
    }
}

function dismissFavoritePlacesPrompt() {
    const prompt = document.getElementById('favoritePlacesPrompt');
    if (prompt) {
        prompt.style.display = 'none';
        localStorage.setItem('favoritePlacesPromptDismissed', 'true');
    }
}

// Edit apartment modal functions
function openEditApartmentModal(apartmentData) {
    const modal = document.getElementById('editApartmentModal');

    // Populate form fields
    document.getElementById('edit_apartment_id').value = apartmentData.pk || apartmentData.id;
    document.getElementById('edit_name').value = apartmentData.name;
    document.getElementById('edit_address').value = apartmentData.address || '';
    document.getElementById('edit_price').value = apartmentData.price;
    document.getElementById('edit_square_footage').value = apartmentData.square_footage;
    document.getElementById('edit_bedrooms').value = apartmentData.bedrooms || 1;
    document.getElementById('edit_bathrooms').value = apartmentData.bathrooms || 1;
    document.getElementById('edit_lease_length_months').value = apartmentData.lease_length_months || 12;
    document.getElementById('edit_months_free').value = apartmentData.months_free || 0;
    document.getElementById('edit_weeks_free').value = apartmentData.weeks_free || 0;
    document.getElementById('edit_flat_discount').value = apartmentData.flat_discount || 0;

    // Show advanced options if any discount fields are set
    if (apartmentData.months_free || apartmentData.weeks_free || apartmentData.flat_discount || apartmentData.lease_length_months != 12) {
        const advancedOptions = document.getElementById('editAdvancedOptions');
        const chevron = document.getElementById('editAdvancedChevron');
        advancedOptions.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    }

    modal.classList.remove('hidden');
}

function closeEditApartmentModal() {
    document.getElementById('editApartmentModal').classList.add('hidden');
    // Reset form
    document.getElementById('editApartmentForm').reset();
    // Hide error message
    document.getElementById('editApartmentError').classList.add('hidden');
    // Hide advanced options
    const advancedOptions = document.getElementById('editAdvancedOptions');
    const chevron = document.getElementById('editAdvancedChevron');
    advancedOptions.classList.add('hidden');
    chevron.classList.remove('rotate-180');
}

function toggleEditAdvancedOptions() {
    const advancedOptions = document.getElementById('editAdvancedOptions');
    const chevron = document.getElementById('editAdvancedChevron');

    if (advancedOptions.classList.contains('hidden')) {
        advancedOptions.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        advancedOptions.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

async function handleEditApartment(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const apartmentId = document.getElementById('edit_apartment_id').value;

    // Check if this is a sessionStorage apartment
    if (apartmentId.startsWith('session_')) {
        // Update sessionStorage apartment
        const apartments = getSessionApartments();
        const index = apartments.findIndex(apt => apt.id === apartmentId);

        if (index !== -1) {
            // Update the apartment data
            apartments[index] = {
                id: apartmentId,
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                square_footage: parseInt(formData.get('square_footage')),
                bedrooms: parseFloat(formData.get('bedrooms') || 1),
                bathrooms: parseFloat(formData.get('bathrooms') || 1),
                lease_length_months: parseInt(formData.get('lease_length_months') || 12),
                months_free: parseInt(formData.get('months_free') || 0),
                weeks_free: parseInt(formData.get('weeks_free') || 0),
                flat_discount: parseFloat(formData.get('flat_discount') || 0)
            };

            saveSessionApartments(apartments);
            closeEditApartmentModal();
            window.location.reload();
        } else {
            alert('Apartment not found.');
        }
    } else {
        // Authenticated user - update on server
        try {
            const response = await fetch(`/apartments/apartment/${apartmentId}/update/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (response.ok) {
                closeEditApartmentModal();
                window.location.reload();
            } else {
                const errorText = await response.text();
                alert('Failed to update apartment. Please check your inputs and try again.');
                console.error('Error:', errorText);
            }
        } catch (error) {
            alert('An error occurred while updating the apartment.');
            console.error('Error:', error);
        }
    }
}

// Table sorting functionality
let sortDirection = {
    name: 'asc',
    price: 'asc',
    net_price: 'asc',
    square_footage: 'desc',
    bedrooms: 'desc',
    bathrooms: 'desc',
    price_per_sqft: 'asc',
    discount: 'asc',
    avg_distance: 'asc'
};

// Initialize sort directions for individual distance columns
{% for place in favorite_places %}
sortDirection['distance_{{ place.label|slugify }}'] = 'asc';
{% endfor %}

function sortTable(column) {
    const tbody = document.getElementById('apartmentsTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const hasDiscounts = {{ has_discounts|yesno:"true,false" }};

    // Toggle sort direction
    sortDirection[column] = sortDirection[column] === 'asc' ? 'desc' : 'asc';
    const direction = sortDirection[column];

    rows.sort((a, b) => {
        let aVal, bVal;

        switch(column) {
            case 'name':
                aVal = a.querySelector('[data-field="name"]').textContent.trim();
                bVal = b.querySelector('[data-field="name"]').textContent.trim();
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);

            case 'price':
                aVal = parseFloat(a.querySelector('[data-field="price"]').textContent.replace(/[$,]/g, ''));
                bVal = parseFloat(b.querySelector('[data-field="price"]').textContent.replace(/[$,]/g, ''));
                break;

            case 'net_price':
                // Net Effective is always the 3rd column (index 2) when it exists
                const netPriceIndex = 2;
                aVal = parseFloat(a.querySelectorAll('td')[netPriceIndex].textContent.replace(/[$,]/g, ''));
                bVal = parseFloat(b.querySelectorAll('td')[netPriceIndex].textContent.replace(/[$,]/g, ''));
                break;

            case 'square_footage':
                aVal = parseFloat(a.querySelector('[data-field="square_footage"]').textContent.replace(/,/g, ''));
                bVal = parseFloat(b.querySelector('[data-field="square_footage"]').textContent.replace(/,/g, ''));
                break;

            case 'bedrooms':
                aVal = parseFloat(a.querySelector('[data-field="bedrooms"]').textContent.replace(/,/g, ''));
                bVal = parseFloat(b.querySelector('[data-field="bedrooms"]').textContent.replace(/,/g, ''));
                break;

            case 'bathrooms':
                aVal = parseFloat(a.querySelector('[data-field="bathrooms"]').textContent.replace(/,/g, ''));
                bVal = parseFloat(b.querySelector('[data-field="bathrooms"]').textContent.replace(/,/g, ''));
                break;

            case 'score':
                // Sort by score (higher is better)
                const aScoreEl = a.querySelector('[data-field="score"]');
                const bScoreEl = b.querySelector('[data-field="score"]');
                aVal = aScoreEl ? parseFloat(aScoreEl.textContent.replace(/[^\d.]/g, '')) : 0;
                bVal = bScoreEl ? parseFloat(bScoreEl.textContent.replace(/[^\d.]/g, '')) : 0;
                break;

            case 'price_per_sqft':
                // Adjust column index based on whether Net Effective column exists
                const pricePerSqftIndex = hasDiscounts ? 4 : 3;
                aVal = parseFloat(a.querySelectorAll('td')[pricePerSqftIndex].textContent.replace(/[$,]/g, ''));
                bVal = parseFloat(b.querySelectorAll('td')[pricePerSqftIndex].textContent.replace(/[$,]/g, ''));
                break;

            case 'discount':
                // Sort by actual monthly discount amount (higher discount = better deal)
                // Use the data-discount-amount attribute
                aVal = parseFloat(a.querySelector('[data-discount-amount]').getAttribute('data-discount-amount'));
                bVal = parseFloat(b.querySelector('[data-discount-amount]').getAttribute('data-discount-amount'));
                break;

            case 'avg_distance':
                // Sort by average distance
                const aAvgEl = a.querySelector('[data-avg-distance]');
                const bAvgEl = b.querySelector('[data-avg-distance]');
                aVal = aAvgEl ? parseFloat(aAvgEl.getAttribute('data-avg-distance')) : 999;
                bVal = bAvgEl ? parseFloat(bAvgEl.getAttribute('data-avg-distance')) : 999;
                break;

            default:
                // Handle individual distance columns (distance_work, distance_gym, etc.)
                if (column.startsWith('distance_')) {
                    const aDistEl = a.querySelector(`[data-distance-${column.replace('distance_', '')}]`);
                    const bDistEl = b.querySelector(`[data-distance-${column.replace('distance_', '')}]`);
                    aVal = aDistEl ? parseFloat(aDistEl.getAttribute(`data-distance-${column.replace('distance_', '')}`)) : 999;
                    bVal = bDistEl ? parseFloat(bDistEl.getAttribute(`data-distance-${column.replace('distance_', '')}`)) : 999;
                }
                break;
        }

        return direction === 'asc' ? aVal - bVal : bVal - aVal;
    });

    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
}

// Mobile card sorting functionality
function sortMobileCards(sortValue) {
    const cardView = document.getElementById('cardView');
    if (!cardView) return;

    const cards = Array.from(cardView.querySelectorAll('[data-name]'));
    if (cards.length === 0) return;

    const [column, direction] = sortValue.split('-');

    cards.sort((a, b) => {
        let aVal, bVal;

        switch(column) {
            case 'name':
                aVal = a.getAttribute('data-name') || '';
                bVal = b.getAttribute('data-name') || '';
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);

            case 'price':
                aVal = parseFloat(a.getAttribute('data-price')) || 0;
                bVal = parseFloat(b.getAttribute('data-price')) || 0;
                break;

            case 'net_price':
                aVal = parseFloat(a.getAttribute('data-net-price')) || 0;
                bVal = parseFloat(b.getAttribute('data-net-price')) || 0;
                break;

            case 'square_footage':
                aVal = parseFloat(a.getAttribute('data-sqft')) || 0;
                bVal = parseFloat(b.getAttribute('data-sqft')) || 0;
                break;

            case 'bedrooms':
                aVal = parseFloat(a.getAttribute('data-bedrooms')) || 0;
                bVal = parseFloat(b.getAttribute('data-bedrooms')) || 0;
                break;

            case 'bathrooms':
                aVal = parseFloat(a.getAttribute('data-bathrooms')) || 0;
                bVal = parseFloat(b.getAttribute('data-bathrooms')) || 0;
                break;

            case 'score':
                aVal = parseFloat(a.getAttribute('data-score')) || 0;
                bVal = parseFloat(b.getAttribute('data-score')) || 0;
                break;

            case 'price_per_sqft':
                aVal = parseFloat(a.getAttribute('data-price-per-sqft')) || 0;
                bVal = parseFloat(b.getAttribute('data-price-per-sqft')) || 0;
                break;

            case 'discount':
                aVal = parseFloat(a.getAttribute('data-discount-amount')) || 0;
                bVal = parseFloat(b.getAttribute('data-discount-amount')) || 0;
                break;

            case 'avg_distance':
                aVal = parseFloat(a.getAttribute('data-avg-distance')) || 999;
                bVal = parseFloat(b.getAttribute('data-avg-distance')) || 999;
                break;

            default:
                aVal = 0;
                bVal = 0;
        }

        return direction === 'asc' ? aVal - bVal : bVal - aVal;
    });

    // Re-append cards in sorted order
    cards.forEach(card => cardView.appendChild(card));
}

// Score Tuner Modal functionality
function openScoreTuner() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('scoreTunerModal');
    if (!modal) {
        modal = createScoreTunerModal();
        document.body.appendChild(modal);
    }

    // Show modal first
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.add('show'), 10);

    // Initialize content based on user tier
    if (isPremium) {
        setTimeout(() => initializePriorityList(), 10);
    } else {
        setTimeout(() => initializeFreeTierList(), 10);
    }
}

function createScoreTunerModal() {
    const discountCalcMethod = '{{ preferences.discount_calculation|default:"weekly" }}';
    const modal = document.createElement('div');
    modal.id = 'scoreTunerModal';
    modal.className = 'hidden fixed inset-0 z-50 overflow-y-auto';
    modal.setAttribute('aria-labelledby', 'modal-title');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');

    // Create content based on premium status
    const slidersContent = isPremium ? `
        <!-- Premium: Drag and Drop Priority List -->
        <div class="space-y-4">
            <p class="text-sm text-gray-600 dark:text-gray-400">
                Drag to rank by importance. Your top 4 factors will be used in scoring.
            </p>

            <!-- Priority List -->
            <div id="factorPriorityList" class="space-y-2">
                <!-- Items will be inserted here by JavaScript -->
            </div>

            <!-- Divider -->
            <div class="flex items-center my-4">
                <div class="flex-1 border-t-2 border-dashed border-gray-300 dark:border-gray-600"></div>
                <span class="px-3 text-xs text-gray-500 dark:text-gray-400 font-medium">Not used in scoring</span>
                <div class="flex-1 border-t-2 border-dashed border-gray-300 dark:border-gray-600"></div>
            </div>

            <!-- Unused Factors -->
            <div id="unusedFactorsList" class="space-y-2">
                <!-- Unused items will be inserted here by JavaScript -->
            </div>
        </div>
    ` : `
        <!-- Free: Drag and Drop for 2 Factors -->
        <div class="space-y-4">
            <p class="text-sm text-gray-600 dark:text-gray-400">
                Drag to rank by importance. Your top 2 factors will be used in scoring.
            </p>

            <!-- Free Tier Priority List -->
            <div id="freeFactorList" class="space-y-2">
                <!-- Items will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Upgrade Prompt -->
        <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4 mt-6">
            <div class="flex items-start">
                <svg class="h-5 w-5 text-purple-600 dark:text-purple-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                </svg>
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-purple-900 dark:text-purple-100 mb-1">Get 2 Additional Ranking Factors</h4>
                    <p class="text-xs text-purple-700 dark:text-purple-300 mb-2">Upgrade to Pro to rank up to 4 factors total, including:</p>
                    <ul class="text-xs text-purple-700 dark:text-purple-300 list-disc list-inside space-y-0.5">
                        <li>Base Rent</li>
                        <li>Distance to Favorite Places</li>
                        <li>Bedrooms</li>
                        <li>Bathrooms</li>
                    </ul>
                    <a href="/signup" class="inline-flex items-center mt-2 px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors">
                        Upgrade to Pro
                    </a>
                </div>
            </div>
        </div>
    `;

    modal.innerHTML = `
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeScoreTuner()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-neutral-800 rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-gray-200 dark:border-neutral-700">
                <div class="bg-white dark:bg-neutral-800 px-6 pt-6 pb-4 sm:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="modal-title">
                                Preferences
                            </h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                Customize scoring and calculations
                            </p>
                        </div>
                        <button onclick="closeScoreTuner()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    ${slidersContent}

                    <!-- Discount Calculation Method -->
                    <div class="mt-6 p-4 bg-gray-50 dark:bg-neutral-900 rounded-lg border border-gray-200 dark:border-neutral-700">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Discount Calculation Method</h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Choose how to calculate the value of free months/weeks when comparing apartments:</p>
                        <div class="space-y-3">
                            <label class="flex items-start cursor-pointer">
                                <input type="radio" name="discount_calc_tuner" value="daily" ${discountCalcMethod === 'daily' ? 'checked' : ''}
                                       class="h-4 w-4 text-brand-purple focus:ring-brand-purple border-gray-300 dark:border-neutral-600 mt-0.5">
                                <span class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                    <span class="font-medium">Daily Rate</span> - Divides annual rent by 365 days<br>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">Example: $24,000/year √∑ 365 = $65.75/day</span>
                                </span>
                            </label>
                            <label class="flex items-start cursor-pointer">
                                <input type="radio" name="discount_calc_tuner" value="weekly" ${discountCalcMethod === 'weekly' ? 'checked' : ''}
                                       class="h-4 w-4 text-brand-purple focus:ring-brand-purple border-gray-300 dark:border-neutral-600 mt-0.5">
                                <span class="ml-3 text-sm text-gray-700 dark:text-gray-300">
                                    <span class="font-medium">Weekly Rate</span> - Divides annual rent by 52 weeks<br>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">Example: $24,000/year √∑ 52 = $461.54/week</span>
                                </span>
                            </label>
                        </div>
                        <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded text-xs text-blue-800 dark:text-blue-300">
                            <strong>Note:</strong> Changing this will recalculate the Net Effective Rent for all apartments with discounts
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-neutral-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200 dark:border-neutral-700">
                    <button onclick="saveScoreWeights()" type="button" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-brand-purple text-base font-medium text-white hover:bg-brand-purple-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-purple transition-colors sm:ml-3 sm:w-auto sm:text-sm">
                        Save Changes
                    </button>
                    <button onclick="closeScoreTuner()" type="button" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 dark:border-neutral-600 shadow-sm px-4 py-2 bg-white dark:bg-neutral-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-purple transition-colors sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

    return modal;
}

function closeScoreTuner() {
    const modal = document.getElementById('scoreTunerModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }
}

// Premium: Drag and Drop Priority List Functions
function initializePriorityList() {
    // Create a map of factor keys to their data
    const factorMap = {
        'price': { key: 'price', label: 'Base Rent', weight: userPreferences.priceWeight },
        'netRent': { key: 'netRent', label: 'Net Effective Rent', weight: userPreferences.netRentWeight },
        'sqft': { key: 'sqft', label: 'Square Footage', weight: userPreferences.sqftWeight },
        'bedrooms': { key: 'bedrooms', label: 'Bedrooms', weight: userPreferences.bedroomsWeight },
        'bathrooms': { key: 'bathrooms', label: 'Bathrooms', weight: userPreferences.bathroomsWeight },
        'distance': { key: 'distance', label: 'Distance to Favorite Places', weight: userPreferences.distanceWeight },
        'discount': { key: 'discount', label: 'Discount Amount', weight: userPreferences.discountWeight }
    };

    // Get stored order or use default
    const storedOrder = userPreferences.factorOrder || 'price,sqft,distance,netRent,bedrooms,bathrooms,discount';
    const orderKeys = storedOrder.split(',').filter(k => k && factorMap[k]);

    // Build ordered factors list using stored order
    const orderedFactors = [];
    orderKeys.forEach(key => {
        if (factorMap[key]) {
            orderedFactors.push(factorMap[key]);
        }
    });

    // Add any missing factors at the end (in case new factors were added)
    Object.keys(factorMap).forEach(key => {
        if (!orderKeys.includes(key)) {
            orderedFactors.push(factorMap[key]);
        }
    });

    // Split into priority (top 4 with weight > 0) and unused (rest)
    // Factors with weight > 0 go to priority, others to unused, maintaining order
    const priorityFactors = [];
    const unusedFactors = [];

    orderedFactors.forEach(factor => {
        if (factor.weight > 0 && priorityFactors.length < 4) {
            priorityFactors.push(factor);
        } else {
            unusedFactors.push(factor);
        }
    });

    // Render priority list
    const priorityList = document.getElementById('factorPriorityList');
    if (priorityList) {
        priorityList.innerHTML = '';
        priorityFactors.forEach((factor, index) => {
            priorityList.appendChild(createFactorItem(factor, index, true, priorityFactors.length, unusedFactors.length));
        });
    }

    // Render unused list
    const unusedList = document.getElementById('unusedFactorsList');
    if (unusedList) {
        unusedList.innerHTML = '';
        unusedFactors.forEach((factor, index) => {
            unusedList.appendChild(createFactorItem(factor, index, false, priorityFactors.length, unusedFactors.length));
        });
    }
}

// Free Tier: Drag and Drop for 2 Factors
function initializeFreeTierList() {
    const freeFactors = [
        { key: 'netRent', label: 'Net Effective Rent', weight: userPreferences.netRentWeight },
        { key: 'sqft', label: 'Square Footage', weight: userPreferences.sqftWeight }
    ];

    // Sort by current weight (descending)
    freeFactors.sort((a, b) => b.weight - a.weight);

    // Render free tier list
    const freeList = document.getElementById('freeFactorList');
    if (freeList) {
        freeList.innerHTML = '';
        freeFactors.forEach((factor, index) => {
            freeList.appendChild(createFreeFactorItem(factor, index, freeFactors.length));
        });
    }
}

function createFreeFactorItem(factor, index, total) {
    const div = document.createElement('div');
    div.className = 'factor-item flex items-center justify-between p-3 bg-white dark:bg-neutral-700 border border-gray-200 dark:border-neutral-600 rounded-lg hover:border-brand-purple transition-colors';
    div.dataset.factorKey = factor.key;

    const isFirst = index === 0;
    const isLast = index === total - 1;

    // Build arrow buttons based on position
    let arrowButtons = '';
    if (total > 1) {
        if (isFirst) {
            arrowButtons = `
                <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            `;
        } else if (isLast) {
            arrowButtons = `
                <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="up">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                </button>
            `;
        } else {
            arrowButtons = `
                <div class="inline-flex rounded-lg border border-gray-200 dark:border-neutral-600 overflow-hidden">
                    <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600 border-r border-gray-200 dark:border-neutral-600" data-direction="up">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                    </button>
                    <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            `;
        }
    }

    div.innerHTML = `
        <div class="flex items-center flex-1">
            <span class="text-sm font-medium text-gray-900 dark:text-white">${factor.label}</span>
        </div>
        <div class="flex items-center gap-2">
            ${arrowButtons}
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold bg-brand-purple text-white">
                ${index + 1}
            </span>
        </div>
    `;

    // Add arrow click handlers
    const upBtn = div.querySelector('[data-direction="up"]');
    const downBtn = div.querySelector('[data-direction="down"]');
    if (upBtn) upBtn.addEventListener('click', handleArrowClickFreeTier);
    if (downBtn) downBtn.addEventListener('click', handleArrowClickFreeTier);

    return div;
}

function handleDropFreeTier(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    if (draggedElement !== this) {
        const freeList = document.getElementById('freeFactorList');
        const allItems = Array.from(freeList.children);

        // Find positions
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(this);

        // Swap elements
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }

        // Rebuild free tier list
        rebuildFreeTierList();
    }

    return false;
}

function handleArrowClickFreeTier(e) {
    const button = e.currentTarget;
    const direction = button.dataset.direction;
    const item = button.closest('.factor-item');
    const list = item.parentElement;

    if (direction === 'up' && item.previousElementSibling) {
        list.insertBefore(item, item.previousElementSibling);
    } else if (direction === 'down' && item.nextElementSibling) {
        list.insertBefore(item.nextElementSibling, item);
    }

    rebuildFreeTierList();
}

function rebuildFreeTierList() {
    const freeList = document.getElementById('freeFactorList');
    const allItems = Array.from(freeList.children);
    const total = allItems.length;

    // Clear list
    freeList.innerHTML = '';

    // Rebuild with updated rankings
    allItems.forEach((item, index) => {
        const factorKey = item.dataset.factorKey;
        const label = item.querySelector('span.text-sm').textContent;
        const isFirst = index === 0;
        const isLast = index === total - 1;

        // Build arrow buttons based on position
        let arrowButtons = '';
        if (total > 1) {
            if (isFirst) {
                arrowButtons = `
                    <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                `;
            } else if (isLast) {
                arrowButtons = `
                    <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="up">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                    </button>
                `;
            } else {
                arrowButtons = `
                    <div class="inline-flex rounded-lg border border-gray-200 dark:border-neutral-600 overflow-hidden">
                        <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600 border-r border-gray-200 dark:border-neutral-600" data-direction="up">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                            </svg>
                        </button>
                        <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }
        }

        const newItem = document.createElement('div');
        newItem.className = item.className;
        newItem.dataset.factorKey = factorKey;
        newItem.innerHTML = `
            <div class="flex items-center flex-1">
                <span class="text-sm font-medium text-gray-900 dark:text-white">${label}</span>
            </div>
            <div class="flex items-center gap-2">
                ${arrowButtons}
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold bg-brand-purple text-white">
                    ${index + 1}
                </span>
            </div>
        `;

        // Add arrow click handlers
        const upBtn = newItem.querySelector('[data-direction="up"]');
        const downBtn = newItem.querySelector('[data-direction="down"]');
        if (upBtn) upBtn.addEventListener('click', handleArrowClickFreeTier);
        if (downBtn) downBtn.addEventListener('click', handleArrowClickFreeTier);

        freeList.appendChild(newItem);
    });
}

function createFactorItem(factor, index, isPriority, totalPriority, totalUnused) {
    const weights = [40, 30, 20, 10];
    const weight = isPriority ? weights[index] : 0;
    const totalAll = totalPriority + totalUnused;

    const div = document.createElement('div');
    div.className = 'factor-item flex items-center justify-between p-3 bg-white dark:bg-neutral-700 border border-gray-200 dark:border-neutral-600 rounded-lg hover:border-brand-purple transition-colors';
    div.dataset.factorKey = factor.key;

    // Calculate overall position for arrow logic
    const overallIndex = isPriority ? index : totalPriority + index;
    const isFirst = overallIndex === 0;
    const isLast = overallIndex === totalAll - 1;

    // Build arrow buttons based on overall position
    let arrowButtons = '';
    if (totalAll > 1) {
        if (isFirst) {
            arrowButtons = `
                <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            `;
        } else if (isLast) {
            arrowButtons = `
                <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="up">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                </button>
            `;
        } else {
            arrowButtons = `
                <div class="inline-flex rounded-lg border border-gray-200 dark:border-neutral-600 overflow-hidden">
                    <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600 border-r border-gray-200 dark:border-neutral-600" data-direction="up">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                    </button>
                    <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            `;
        }
    }

    div.innerHTML = `
        <div class="flex items-center flex-1">
            <span class="text-sm font-medium text-gray-900 dark:text-white">${factor.label}</span>
        </div>
        <div class="flex items-center gap-2">
            ${arrowButtons}
            ${isPriority ? `
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold bg-brand-purple text-white">
                    ${index + 1}
                </span>
            ` : `
                <span class="text-xs text-gray-400 dark:text-gray-500">Unused</span>
            `}
        </div>
    `;

    // Add arrow click handlers
    const upBtn = div.querySelector('[data-direction="up"]');
    const downBtn = div.querySelector('[data-direction="down"]');
    if (upBtn) upBtn.addEventListener('click', handleArrowClickProTier);
    if (downBtn) downBtn.addEventListener('click', handleArrowClickProTier);

    return div;
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.style.opacity = '1';

    // Remove all drag-over styling
    document.querySelectorAll('.factor-item').forEach(item => {
        item.classList.remove('border-brand-purple', 'bg-purple-50', 'dark:bg-purple-900/20');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('border-brand-purple', 'bg-purple-50', 'dark:bg-purple-900/20');
    }
}

function handleDragLeave(e) {
    this.classList.remove('border-brand-purple', 'bg-purple-50', 'dark:bg-purple-900/20');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    if (draggedElement !== this) {
        // Get all items from both lists
        const priorityList = document.getElementById('factorPriorityList');
        const unusedList = document.getElementById('unusedFactorsList');

        const allItems = [
            ...Array.from(priorityList.children),
            ...Array.from(unusedList.children)
        ];

        // Find positions
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(this);

        // Swap elements
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }

        // Rebuild lists
        rebuildPriorityLists();
    }

    return false;
}

function handleArrowClickProTier(e) {
    const button = e.currentTarget;
    const direction = button.dataset.direction;
    const item = button.closest('.factor-item');
    const priorityList = document.getElementById('factorPriorityList');
    const unusedList = document.getElementById('unusedFactorsList');

    // Get all items in order
    const allItems = [
        ...Array.from(priorityList.children),
        ...Array.from(unusedList.children)
    ];
    const currentIndex = allItems.indexOf(item);

    if (direction === 'up' && currentIndex > 0) {
        const prevItem = allItems[currentIndex - 1];
        // Insert before the previous item (in whichever list it's in)
        prevItem.parentNode.insertBefore(item, prevItem);
    } else if (direction === 'down' && currentIndex < allItems.length - 1) {
        const nextItem = allItems[currentIndex + 1];
        // Insert after the next item (in whichever list it's in)
        nextItem.parentNode.insertBefore(item, nextItem.nextSibling);
    }

    rebuildPriorityLists();
}

function rebuildPriorityLists() {
    const priorityList = document.getElementById('factorPriorityList');
    const unusedList = document.getElementById('unusedFactorsList');

    // Get all items
    const allItems = [
        ...Array.from(priorityList.children),
        ...Array.from(unusedList.children)
    ];

    // Clear both lists
    priorityList.innerHTML = '';
    unusedList.innerHTML = '';

    const weights = [40, 30, 20, 10];
    const totalAll = allItems.length;

    // Redistribute: first 4 go to priority, rest to unused
    allItems.forEach((item, index) => {
        const factorKey = item.dataset.factorKey;
        const label = item.querySelector('span.text-sm').textContent;
        const isFirst = index === 0;
        const isLast = index === totalAll - 1;

        // Build arrow buttons based on overall position
        let arrowButtons = '';
        if (totalAll > 1) {
            if (isFirst) {
                arrowButtons = `
                    <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                `;
            } else if (isLast) {
                arrowButtons = `
                    <button type="button" class="p-1.5 rounded-lg border border-gray-200 dark:border-neutral-600 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="up">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                    </button>
                `;
            } else {
                arrowButtons = `
                    <div class="inline-flex rounded-lg border border-gray-200 dark:border-neutral-600 overflow-hidden">
                        <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600 border-r border-gray-200 dark:border-neutral-600" data-direction="up">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                            </svg>
                        </button>
                        <button type="button" class="p-1.5 text-gray-400 dark:text-gray-500 hover:text-brand-purple hover:bg-gray-100 dark:hover:bg-neutral-600" data-direction="down">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                `;
            }
        }

        if (index < 4) {
            // Priority item
            const weight = weights[index];

            const newItem = document.createElement('div');
            newItem.className = item.className;
            newItem.dataset.factorKey = factorKey;
            newItem.innerHTML = `
                <div class="flex items-center flex-1">
                    <span class="text-sm font-medium text-gray-900 dark:text-white">${label}</span>
                </div>
                <div class="flex items-center gap-2">
                    ${arrowButtons}
                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-semibold bg-brand-purple text-white">
                        ${index + 1}
                    </span>
                </div>
            `;

            // Add arrow click handlers
            const upBtn = newItem.querySelector('[data-direction="up"]');
            const downBtn = newItem.querySelector('[data-direction="down"]');
            if (upBtn) upBtn.addEventListener('click', handleArrowClickProTier);
            if (downBtn) downBtn.addEventListener('click', handleArrowClickProTier);

            priorityList.appendChild(newItem);
        } else {
            // Unused item
            const newItem = document.createElement('div');
            newItem.className = item.className;
            newItem.dataset.factorKey = factorKey;
            newItem.innerHTML = `
                <div class="flex items-center flex-1">
                    <span class="text-sm font-medium text-gray-900 dark:text-white">${label}</span>
                </div>
                <div class="flex items-center gap-2">
                    ${arrowButtons}
                    <span class="text-xs text-gray-400 dark:text-gray-500">Unused</span>
                </div>
            `;

            // Add arrow click handlers
            const upBtn = newItem.querySelector('[data-direction="up"]');
            const downBtn = newItem.querySelector('[data-direction="down"]');
            if (upBtn) upBtn.addEventListener('click', handleArrowClickProTier);
            if (downBtn) downBtn.addEventListener('click', handleArrowClickProTier);

            unusedList.appendChild(newItem);
        }
    });
}

function saveScoreWeights() {
    const form = document.getElementById('preferencesForm');
    if (!form) {
        console.error('Preferences form not found');
        closeScoreTuner();
        return;
    }

    if (isPremium) {
        // Premium: Get priority order from drag-and-drop lists
        const priorityList = document.getElementById('factorPriorityList');
        const unusedList = document.getElementById('unusedFactorsList');

        const weights = [40, 30, 20, 10];
        const factorWeights = {
            price: 0,
            netRent: 0,
            sqft: 0,
            bedrooms: 0,
            bathrooms: 0,
            distance: 0,
            discount: 0
        };

        // Assign weights to priority items
        if (priorityList) {
            Array.from(priorityList.children).forEach((item, index) => {
                const factorKey = item.dataset.factorKey;
                factorWeights[factorKey] = weights[index];
            });
        }

        // Unused items get 0 weight (already initialized to 0)

        // Build factor order string (priority items first, then unused items)
        const factorOrderKeys = [];
        if (priorityList) {
            Array.from(priorityList.children).forEach(item => {
                factorOrderKeys.push(item.dataset.factorKey);
            });
        }
        if (unusedList) {
            Array.from(unusedList.children).forEach(item => {
                factorOrderKeys.push(item.dataset.factorKey);
            });
        }
        const factorOrderString = factorOrderKeys.join(',');

        // Update form inputs
        const priceInput = form.querySelector('input[name="price_weight"]');
        const netRentInput = form.querySelector('input[name="net_rent_weight"]');
        const sqftInput = form.querySelector('input[name="sqft_weight"]');
        const bedroomsInput = form.querySelector('input[name="bedrooms_weight"]');
        const bathroomsInput = form.querySelector('input[name="bathrooms_weight"]');
        const distanceInput = form.querySelector('input[name="distance_weight"]');
        const discountInput = form.querySelector('input[name="discount_weight"]');
        const factorOrderInput = form.querySelector('input[name="factor_order"]');

        if (priceInput) priceInput.value = factorWeights.price;
        if (netRentInput) netRentInput.value = factorWeights.netRent;
        if (sqftInput) sqftInput.value = factorWeights.sqft;
        if (bedroomsInput) bedroomsInput.value = factorWeights.bedrooms;
        if (bathroomsInput) bathroomsInput.value = factorWeights.bathrooms;
        if (distanceInput) distanceInput.value = factorWeights.distance;
        if (discountInput) discountInput.value = factorWeights.discount;
        if (factorOrderInput) factorOrderInput.value = factorOrderString;
    } else {
        // Free: Get priority order from drag-and-drop list
        const freeList = document.getElementById('freeFactorList');

        // Weights: #1 gets 2/3 (67), #2 gets 1/3 (33)
        const weights = [67, 33];
        const factorWeights = {
            price: 0,
            netRent: 0,
            sqft: 0,
            bedrooms: 0,
            bathrooms: 0,
            distance: 0,
            discount: 0
        };

        // Assign weights based on order
        const freeFactorOrderKeys = [];
        if (freeList) {
            Array.from(freeList.children).forEach((item, index) => {
                const factorKey = item.dataset.factorKey;
                factorWeights[factorKey] = weights[index];
                freeFactorOrderKeys.push(factorKey);
            });
        }
        // For free users, build factor order with their 2 factors first, then others
        const allKeys = ['price', 'sqft', 'distance', 'netRent', 'bedrooms', 'bathrooms', 'discount'];
        const otherKeys = allKeys.filter(k => !freeFactorOrderKeys.includes(k));
        const freeFactorOrderString = [...freeFactorOrderKeys, ...otherKeys].join(',');

        // Update form inputs (free users only use netRent and sqft)
        const priceInput = form.querySelector('input[name="price_weight"]');
        const netRentInput = form.querySelector('input[name="net_rent_weight"]');
        const sqftInput = form.querySelector('input[name="sqft_weight"]');
        const bedroomsInput = form.querySelector('input[name="bedrooms_weight"]');
        const bathroomsInput = form.querySelector('input[name="bathrooms_weight"]');
        const distanceInput = form.querySelector('input[name="distance_weight"]');
        const discountInput = form.querySelector('input[name="discount_weight"]');
        const factorOrderInput = form.querySelector('input[name="factor_order"]');

        if (priceInput) priceInput.value = factorWeights.price;
        if (netRentInput) netRentInput.value = factorWeights.netRent;
        if (sqftInput) sqftInput.value = factorWeights.sqft;
        if (bedroomsInput) bedroomsInput.value = factorWeights.bedrooms;
        if (bathroomsInput) bathroomsInput.value = factorWeights.bathrooms;
        if (distanceInput) distanceInput.value = factorWeights.distance;
        if (discountInput) discountInput.value = factorWeights.discount;
        if (factorOrderInput) factorOrderInput.value = freeFactorOrderString;
    }

    // Get discount calculation method from Score Tuner modal
    const discountCalcRadio = document.querySelector('input[name="discount_calc_tuner"]:checked');
    if (discountCalcRadio) {
        let discountInput = form.querySelector('input[name="discount_calculation"]');
        if (!discountInput) {
            discountInput = document.createElement('input');
            discountInput.type = 'hidden';
            discountInput.name = 'discount_calculation';
            form.appendChild(discountInput);
        }
        discountInput.value = discountCalcRadio.value;
    }

    // Submit the form (it will trigger score recalculation automatically)
    form.submit();
}

// Async distance fetching
const apartmentsNeedingDistances = {{ apartments_needing_distances|safe }};

async function fetchDistancesForApartment(apartmentId) {
    try {
        const response = await fetch(`/apartments/api/apartment/${apartmentId}/distances/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            console.error(`Failed to fetch distances for apartment ${apartmentId}`);
            return;
        }

        const data = await response.json();
        updateDistanceUI(apartmentId, data);
    } catch (error) {
        console.error(`Error fetching distances for apartment ${apartmentId}:`, error);
    }
}

function updateDistanceUI(apartmentId, data) {
    // Update mobile card
    const mobileContainer = document.querySelector(`[data-distance-container][data-apartment-id="${apartmentId}"]`);
    if (mobileContainer) {
        const loadingEl = mobileContainer.querySelector('[data-distance-loading]');
        if (loadingEl) {
            // Build new content
            let html = '';
            const distances = data.distances;

            // Sort by travel time
            const sortedEntries = Object.entries(distances).sort((a, b) => {
                const aTime = a[1].travel_time ?? 9999;
                const bTime = b[1].travel_time ?? 9999;
                return aTime - bTime;
            });

            for (const [label, info] of sortedEntries) {
                html += `<div class="flex justify-between items-center" data-distance-row data-place-label="${label}">
                    <span class="text-gray-500 truncate mr-2">${label}</span>
                    <span class="font-medium text-gray-900 dark:text-white flex-shrink-0" data-distance-value>`;

                if (info.travel_time != null) {
                    html += `${info.travel_time} min <span class="text-gray-500 font-normal">(${info.distance.toFixed(1)} mi)</span>`;
                } else if (info.distance != null) {
                    html += `${info.distance.toFixed(1)} mi`;
                } else {
                    html += `<span class="text-gray-400">N/A</span>`;
                }
                html += `</span></div>`;
            }

            // Add average if multiple places
            if (sortedEntries.length > 1 && data.average_travel_time != null) {
                html += `<div class="flex justify-between items-center pt-1 border-t border-gray-100 dark:border-neutral-700 mt-1" data-average-row>
                    <span class="text-gray-500 font-medium">Average</span>
                    <span class="font-semibold text-brand-purple flex-shrink-0" data-average-value>
                        ${data.average_travel_time} min
                        <span class="text-brand-purple/70 font-normal">(${data.average_distance.toFixed(1)} mi)</span>
                    </span>
                </div>`;
            }

            mobileContainer.innerHTML = html;
        }
    }

    // Update desktop table cells
    const tableCells = document.querySelectorAll(`td[data-apartment-id="${apartmentId}"]`);
    tableCells.forEach(cell => {
        const placeLabel = cell.getAttribute('data-place-label');
        const valueEl = cell.querySelector('[data-table-distance-value], [data-table-avg-value]');

        if (placeLabel && valueEl) {
            // Individual place cell
            const info = data.distances[placeLabel];
            if (info) {
                let html = '';
                if (info.travel_time != null) {
                    html = `${info.travel_time} min<div class="text-xs text-gray-500 dark:text-gray-400">${info.distance.toFixed(1)} mi</div>`;
                    if (info.transit_fare) {
                        html += `<div class="text-xs text-green-600 dark:text-green-400">$${info.transit_fare.toFixed(2)} fare</div>`;
                    }
                    // Update sorting attribute
                    cell.setAttribute(`data-distance-${placeLabel.toLowerCase().replace(/[^a-z0-9]/g, '')}`, info.travel_time);
                } else if (info.distance != null) {
                    html = `${info.distance.toFixed(1)} mi`;
                } else {
                    html = `<span class="text-gray-400">N/A</span>`;
                }
                valueEl.innerHTML = html;
            }
        } else if (valueEl && cell.hasAttribute('data-avg-distance')) {
            // Average cell
            if (data.average_travel_time != null) {
                valueEl.innerHTML = `${data.average_travel_time} min<div class="text-xs text-brand-purple/70">${data.average_distance.toFixed(1)} mi</div>`;
                cell.setAttribute('data-avg-distance', data.average_travel_time);
            } else if (data.average_distance != null) {
                valueEl.innerHTML = `${data.average_distance.toFixed(1)} mi`;
            }
        }
    });
}

// Fetch distances for all apartments that need them
if (apartmentsNeedingDistances.length > 0) {
    // Fetch sequentially to avoid overwhelming the API
    (async function() {
        for (const apartmentId of apartmentsNeedingDistances) {
            await fetchDistancesForApartment(apartmentId);
        }
    })();
}
</script>

{% endblock %}
